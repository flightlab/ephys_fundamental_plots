<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Data wrangling | Fundamental plots for electrophysiological data</title>
  <meta name="description" content="<p>A walkthrough on how to produce fundamental plots from electrophysiological
data. Developed by the Alshuler Lab at the University of British Columbia.</p>" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Data wrangling | Fundamental plots for electrophysiological data" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>A walkthrough on how to produce fundamental plots from electrophysiological
data. Developed by the Alshuler Lab at the University of British Columbia.</p>" />
  <meta name="github-repo" content="flightlab/ephys_fundamental_plots" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Data wrangling | Fundamental plots for electrophysiological data" />
  
  <meta name="twitter:description" content="<p>A walkthrough on how to produce fundamental plots from electrophysiological
data. Developed by the Alshuler Lab at the University of British Columbia.</p>" />
  

<meta name="author" content="Vikram B. Baliga" />


<meta name="date" content="2023-02-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="raw-data-and-spike-sorted-traces.html"/>
<link rel="next" href="raster-and-mean-spike-rate-plots.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Fundamental plots for electrophysiological data</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#citation"><i class="fa fa-check"></i>Citation</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i><b>2</b> Preface</a>
<ul>
<li class="chapter" data-level="2.1" data-path="preface.html"><a href="preface.html#r-packages-versioning"><i class="fa fa-check"></i><b>2.1</b> R packages &amp; versioning</a></li>
<li class="chapter" data-level="2.2" data-path="preface.html"><a href="preface.html#not_in"><i class="fa fa-check"></i><b>2.2</b> <code>%not_in%</code></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spike-sorting.html"><a href="spike-sorting.html"><i class="fa fa-check"></i><b>3</b> Spike sorting</a>
<ul>
<li class="chapter" data-level="3.1" data-path="spike-sorting.html"><a href="spike-sorting.html#spike2"><i class="fa fa-check"></i><b>3.1</b> Spike2</a></li>
<li class="chapter" data-level="3.2" data-path="spike-sorting.html"><a href="spike-sorting.html#neuralynx"><i class="fa fa-check"></i><b>3.2</b> Neuralynx</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="raw-data-and-spike-sorted-traces.html"><a href="raw-data-and-spike-sorted-traces.html"><i class="fa fa-check"></i><b>4</b> Raw data and spike sorted traces</a>
<ul>
<li class="chapter" data-level="4.1" data-path="raw-data-and-spike-sorted-traces.html"><a href="raw-data-and-spike-sorted-traces.html#including-plots"><i class="fa fa-check"></i><b>4.1</b> Including Plots</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-wrangling.html"><a href="data-wrangling.html"><i class="fa fa-check"></i><b>5</b> Data wrangling</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-wrangling.html"><a href="data-wrangling.html#import-example-file-and-metadata"><i class="fa fa-check"></i><b>5.1</b> Import example file and metadata</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="data-wrangling.html"><a href="data-wrangling.html#identify-files-to-import"><i class="fa fa-check"></i><b>5.1.1</b> Identify files to import</a></li>
<li class="chapter" data-level="5.1.2" data-path="data-wrangling.html"><a href="data-wrangling.html#data-import-and-preliminary-labeling"><i class="fa fa-check"></i><b>5.1.2</b> Data import and preliminary labeling</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data-wrangling.html"><a href="data-wrangling.html#organizing-replicates-required-and-binning-optional"><i class="fa fa-check"></i><b>5.2</b> Organizing replicates (required) and binning (optional)</a></li>
<li class="chapter" data-level="5.3" data-path="data-wrangling.html"><a href="data-wrangling.html#data-export"><i class="fa fa-check"></i><b>5.3</b> Data export</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="raster-and-mean-spike-rate-plots.html"><a href="raster-and-mean-spike-rate-plots.html"><i class="fa fa-check"></i><b>6</b> Raster and mean spike rate plots</a>
<ul>
<li class="chapter" data-level="6.1" data-path="raster-and-mean-spike-rate-plots.html"><a href="raster-and-mean-spike-rate-plots.html#including-plots-1"><i class="fa fa-check"></i><b>6.1</b> Including Plots</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="spatiotemporal-tuning.html"><a href="spatiotemporal-tuning.html"><i class="fa fa-check"></i><b>7</b> Spatiotemporal tuning</a>
<ul>
<li class="chapter" data-level="7.1" data-path="spatiotemporal-tuning.html"><a href="spatiotemporal-tuning.html#including-plots-2"><i class="fa fa-check"></i><b>7.1</b> Including Plots</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="histological-verification.html"><a href="histological-verification.html"><i class="fa fa-check"></i><b>8</b> Histological verification</a>
<ul>
<li class="chapter" data-level="8.1" data-path="histological-verification.html"><a href="histological-verification.html#including-plots-3"><i class="fa fa-check"></i><b>8.1</b> Including Plots</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fundamental plots for electrophysiological data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-wrangling" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">5</span> Data wrangling<a href="data-wrangling.html#data-wrangling" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Once data have been spike sorted, we are ready to begin working in <code>R</code>. To get
to a point where meaningful preliminary plots can be produced, a few things need
to be addressed:</p>
<ol style="list-style-type: decimal">
<li><p>Labeling the time series of spike &amp; photodiode data based on the stimulus
that appears on screen (i.e., matching the log file to the data file). This
includes labeling phases (like “blank”, “stationary”, and “moving”) along
with experimental metadata such as SF, TF, and stimulus orientation
(direction).</p></li>
<li><p>Re-organizing the spike &amp; photodiode so that separate replicates of a
stimulus run are uniquely labelled and then arranged together.</p></li>
<li><p>Binning the data into 10- and 100-ms data sets, and then exporting CSVs of
the unbinned, 10-ms-binned, and 100-ms-binned data. This will be highly
useful for situations where you are handling multiple data files (e.g., from
different recording days), in which case it is likely that your machine will
not be able to store all objects in RAM.</p></li>
</ol>
<blockquote>
<p>Before proceeding any further, please ensure you have installed and loaded all
the necessary <code>R</code> packages as detailed in the Preface section of this guide.</p>
</blockquote>
<div id="import-example-file-and-metadata" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Import example file and metadata<a href="data-wrangling.html#import-example-file-and-metadata" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will use a recently-collected data file and its corresponding metadata file
to showcase the fundamentals of wrangling ephys data into a more easily
plot-able format.</p>
<div id="identify-files-to-import" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Identify files to import<a href="data-wrangling.html#identify-files-to-import" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following code is based on the assumptions that: 1) Your files are stored in
a directory entitled <code>/data</code> 2) The basename of each file (i.e., the name of the
file, excluding the file extension) is identical for each set of spike sorted
data and corresponding metadata log file (e.g., <code>04132022_009m.mat</code> and
<code>04132022_009m</code> have the same basename, which is <code>04132022_009m</code>).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="data-wrangling.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## List all files of each file type</span></span>
<span id="cb6-2"><a href="data-wrangling.html#cb6-2" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span></span>
<span id="cb6-3"><a href="data-wrangling.html#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="st">&quot;./data&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;.csv&quot;</span>,</span>
<span id="cb6-4"><a href="data-wrangling.html#cb6-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-5"><a href="data-wrangling.html#cb6-5" aria-hidden="true" tabindex="-1"></a>mat_files <span class="ot">&lt;-</span></span>
<span id="cb6-6"><a href="data-wrangling.html#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="st">&quot;./data&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;.mat&quot;</span>,</span>
<span id="cb6-7"><a href="data-wrangling.html#cb6-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-8"><a href="data-wrangling.html#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="data-wrangling.html#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate metadata tibbles for each file type</span></span>
<span id="cb6-10"><a href="data-wrangling.html#cb6-10" aria-hidden="true" tabindex="-1"></a>csv_file_info <span class="ot">&lt;-</span></span>
<span id="cb6-11"><a href="data-wrangling.html#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb6-12"><a href="data-wrangling.html#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">csv_files =</span> csv_files,</span>
<span id="cb6-13"><a href="data-wrangling.html#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract the basename by removing the file extension</span></span>
<span id="cb6-14"><a href="data-wrangling.html#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">basename =</span>  <span class="fu">basename</span>(csv_files) <span class="sc">%&gt;%</span> <span class="fu">str_remove</span>(<span class="st">&quot;.csv&quot;</span>),</span>
<span id="cb6-15"><a href="data-wrangling.html#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="do">## </span><span class="al">NOTE</span><span class="do">: PLEASE ADJUST THE FOLLOWING LINE TO BE ABLE TO EXCTRACT OUT THE</span></span>
<span id="cb6-16"><a href="data-wrangling.html#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">## DATE BASED ON YOUR NAMING CONVENTION</span></span>
<span id="cb6-17"><a href="data-wrangling.html#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">basedate =</span>  <span class="fu">basename</span>(csv_files) <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(<span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">12</span>)</span>
<span id="cb6-18"><a href="data-wrangling.html#cb6-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-19"><a href="data-wrangling.html#cb6-19" aria-hidden="true" tabindex="-1"></a>mat_file_info <span class="ot">&lt;-</span></span>
<span id="cb6-20"><a href="data-wrangling.html#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb6-21"><a href="data-wrangling.html#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">mat_files =</span> mat_files,</span>
<span id="cb6-22"><a href="data-wrangling.html#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract the basename by removing the file extension</span></span>
<span id="cb6-23"><a href="data-wrangling.html#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">basename =</span>  <span class="fu">basename</span>(mat_files) <span class="sc">%&gt;%</span> <span class="fu">str_remove</span>(<span class="st">&quot;.mat&quot;</span>),</span>
<span id="cb6-24"><a href="data-wrangling.html#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="do">## </span><span class="al">NOTE</span><span class="do">: AGAIN, PLEASE ADJUST THE FOLLOWING LINE TO BE ABLE TO EXCTRACT OUT</span></span>
<span id="cb6-25"><a href="data-wrangling.html#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="do">## THE DATE BASED ON YOUR NAMING CONVENTION</span></span>
<span id="cb6-26"><a href="data-wrangling.html#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">basedate =</span>  <span class="fu">basename</span>(mat_files) <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(<span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">12</span>)</span>
<span id="cb6-27"><a href="data-wrangling.html#cb6-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-28"><a href="data-wrangling.html#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="data-wrangling.html#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="do">## Matchmake between .MAT data and .CSV log files</span></span>
<span id="cb6-30"><a href="data-wrangling.html#cb6-30" aria-hidden="true" tabindex="-1"></a>csv_mat_filejoin <span class="ot">&lt;-</span></span>
<span id="cb6-31"><a href="data-wrangling.html#cb6-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(csv_file_info, mat_file_info, <span class="at">by =</span> <span class="st">&quot;basename&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-32"><a href="data-wrangling.html#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">## OPTIONAL STEP: remove any rows where either the .MAT or .CSV is missing</span></span>
<span id="cb6-33"><a href="data-wrangling.html#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb6-34"><a href="data-wrangling.html#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="data-wrangling.html#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="do">## Store a vector of basenames in the environment. This will become useful later</span></span>
<span id="cb6-36"><a href="data-wrangling.html#cb6-36" aria-hidden="true" tabindex="-1"></a>base_names <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename</span>
<span id="cb6-37"><a href="data-wrangling.html#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="data-wrangling.html#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Your end products from this code block should look something like:</span></span>
<span id="cb6-39"><a href="data-wrangling.html#cb6-39" aria-hidden="true" tabindex="-1"></a>csv_mat_filejoin</span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   csv_files                basename      basedate.x   mat_files          based…¹
##   &lt;chr&gt;                    &lt;chr&gt;         &lt;chr&gt;        &lt;chr&gt;              &lt;chr&gt;  
## 1 ./data/04132022_009m.csv 04132022_009m 04132022_009 ./data/04132022_0… 041320…
## # … with abbreviated variable name ¹​basedate.y</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="data-wrangling.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## and:</span></span>
<span id="cb8-2"><a href="data-wrangling.html#cb8-2" aria-hidden="true" tabindex="-1"></a>base_names</span></code></pre></div>
<pre><code>## [1] &quot;04132022_009m&quot;</code></pre>
</div>
<div id="data-import-and-preliminary-labeling" class="section level3 hasAnchor" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Data import and preliminary labeling<a href="data-wrangling.html#data-import-and-preliminary-labeling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will now use the <code>R.matlab</code> package to import the <code>.mat</code> file into R and then
label the spike and photodiode time series based on the information in the
<code>.csv</code> log file</p>
<p>Because <code>.mat</code> files can be large, data import can take several minutes.</p>
<p>Please see in-line comments for further guidance</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="data-wrangling.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Tidy up how R has been using RAM by running garbage collection</span></span>
<span id="cb10-2"><a href="data-wrangling.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##           used  (Mb) gc trigger  (Mb) max used  (Mb)
## Ncells 2461925 131.5    3931398 210.0  3931398 210.0
## Vcells 4236696  32.4   10146329  77.5  6794772  51.9</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="data-wrangling.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set up empty vectors that will collect sets of replicates that we will be</span></span>
<span id="cb12-2"><a href="data-wrangling.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="do">## splitting up</span></span>
<span id="cb12-3"><a href="data-wrangling.html#cb12-3" aria-hidden="true" tabindex="-1"></a>metadata_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-4"><a href="data-wrangling.html#cb12-4" aria-hidden="true" tabindex="-1"></a>meta_splits <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-5"><a href="data-wrangling.html#cb12-5" aria-hidden="true" tabindex="-1"></a>data_splits <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-6"><a href="data-wrangling.html#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="data-wrangling.html#cb12-7" aria-hidden="true" tabindex="-1"></a>starttime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>() <span class="do">## Optional, will help you assess run time</span></span>
<span id="cb12-8"><a href="data-wrangling.html#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(csv_mat_filejoin)) {</span>
<span id="cb12-9"><a href="data-wrangling.html#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="data-wrangling.html#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Which file # are we working on?</span></span>
<span id="cb12-11"><a href="data-wrangling.html#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb12-12"><a href="data-wrangling.html#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="data-wrangling.html#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Set up temporary objects in which to eventually write data</span></span>
<span id="cb12-14"><a href="data-wrangling.html#cb12-14" aria-hidden="true" tabindex="-1"></a>  csv_data_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-15"><a href="data-wrangling.html#cb12-15" aria-hidden="true" tabindex="-1"></a>  mat_data_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-16"><a href="data-wrangling.html#cb12-16" aria-hidden="true" tabindex="-1"></a>  joined_data_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-17"><a href="data-wrangling.html#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="data-wrangling.html#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Import the matlab file. This may take some time</span></span>
<span id="cb12-19"><a href="data-wrangling.html#cb12-19" aria-hidden="true" tabindex="-1"></a>  mat_import <span class="ot">&lt;-</span></span>
<span id="cb12-20"><a href="data-wrangling.html#cb12-20" aria-hidden="true" tabindex="-1"></a>    R.matlab<span class="sc">::</span><span class="fu">readMat</span>(csv_mat_filejoin[i,<span class="st">&quot;mat_files&quot;</span>])</span>
<span id="cb12-21"><a href="data-wrangling.html#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="data-wrangling.html#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Read in the corresponding csv log file</span></span>
<span id="cb12-23"><a href="data-wrangling.html#cb12-23" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-24"><a href="data-wrangling.html#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(<span class="fu">as.character</span>(csv_mat_filejoin[i,<span class="st">&quot;csv_files&quot;</span>]),</span>
<span id="cb12-25"><a href="data-wrangling.html#cb12-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-26"><a href="data-wrangling.html#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Rename columns for convenience</span></span>
<span id="cb12-27"><a href="data-wrangling.html#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb12-28"><a href="data-wrangling.html#cb12-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">Spatial_Frequency =</span> <span class="st">`</span><span class="at">Spatial Frequency</span><span class="st">`</span>,</span>
<span id="cb12-29"><a href="data-wrangling.html#cb12-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">Temporal_Frequency =</span> <span class="st">`</span><span class="at">Temporal Frequency</span><span class="st">`</span></span>
<span id="cb12-30"><a href="data-wrangling.html#cb12-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-31"><a href="data-wrangling.html#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Set up a `SF_cpd` column that tranlates SFs to cycles per degree</span></span>
<span id="cb12-32"><a href="data-wrangling.html#cb12-32" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]]<span class="sc">$</span>SF_cpd[csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency <span class="sc">==</span> <span class="fl">0.000668</span>] <span class="ot">&lt;-</span></span>
<span id="cb12-33"><a href="data-wrangling.html#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="sc">^-</span><span class="dv">6</span></span>
<span id="cb12-34"><a href="data-wrangling.html#cb12-34" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]]<span class="sc">$</span>SF_cpd[csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency <span class="sc">==</span> <span class="fl">0.001336</span>] <span class="ot">&lt;-</span></span>
<span id="cb12-35"><a href="data-wrangling.html#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="sc">^-</span><span class="dv">5</span></span>
<span id="cb12-36"><a href="data-wrangling.html#cb12-36" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]]<span class="sc">$</span>SF_cpd[csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency <span class="sc">==</span> <span class="fl">0.00267</span>]  <span class="ot">&lt;-</span></span>
<span id="cb12-37"><a href="data-wrangling.html#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="sc">^-</span><span class="dv">4</span></span>
<span id="cb12-38"><a href="data-wrangling.html#cb12-38" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]]<span class="sc">$</span>SF_cpd[csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency <span class="sc">==</span> <span class="fl">0.0053</span>]   <span class="ot">&lt;-</span></span>
<span id="cb12-39"><a href="data-wrangling.html#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="sc">^-</span><span class="dv">3</span></span>
<span id="cb12-40"><a href="data-wrangling.html#cb12-40" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]]<span class="sc">$</span>SF_cpd[csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency <span class="sc">==</span> <span class="fl">0.0106</span>]   <span class="ot">&lt;-</span></span>
<span id="cb12-41"><a href="data-wrangling.html#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="sc">^-</span><span class="dv">2</span></span>
<span id="cb12-42"><a href="data-wrangling.html#cb12-42" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]]<span class="sc">$</span>SF_cpd[csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency <span class="sc">==</span> <span class="fl">0.0212</span>]   <span class="ot">&lt;-</span></span>
<span id="cb12-43"><a href="data-wrangling.html#cb12-43" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span><span class="sc">^-</span><span class="dv">1</span></span>
<span id="cb12-44"><a href="data-wrangling.html#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="data-wrangling.html#cb12-45" aria-hidden="true" tabindex="-1"></a>  <span class="do">## The log file does not have time = 0, so set up a separate tibble to</span></span>
<span id="cb12-46"><a href="data-wrangling.html#cb12-46" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add this info in later. Some of the metadata will just be filler for now.</span></span>
<span id="cb12-47"><a href="data-wrangling.html#cb12-47" aria-hidden="true" tabindex="-1"></a>  initial <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb12-48"><a href="data-wrangling.html#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">Trial =</span> <span class="st">&quot;initialization&quot;</span>,</span>
<span id="cb12-49"><a href="data-wrangling.html#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">Spatial_Frequency =</span> csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency[<span class="dv">1</span>],</span>
<span id="cb12-50"><a href="data-wrangling.html#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">SF_cpd =</span> csv_data_sets[[i]]<span class="sc">$</span>SF_cpd[<span class="dv">1</span>],</span>
<span id="cb12-51"><a href="data-wrangling.html#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">Temporal_Frequency =</span> csv_data_sets[[i]]<span class="sc">$</span>Temporal_Frequency[<span class="dv">1</span>],</span>
<span id="cb12-52"><a href="data-wrangling.html#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">Direction  =</span> csv_data_sets[[i]]<span class="sc">$</span>Direction[<span class="dv">1</span>],</span>
<span id="cb12-53"><a href="data-wrangling.html#cb12-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> <span class="fl">0.000</span></span>
<span id="cb12-54"><a href="data-wrangling.html#cb12-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-55"><a href="data-wrangling.html#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="data-wrangling.html#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Determine when the onset of motion occurred according to matlab</span></span>
<span id="cb12-57"><a href="data-wrangling.html#cb12-57" aria-hidden="true" tabindex="-1"></a>  <span class="do">## </span><span class="al">NOTE</span><span class="do">: IF THIS INFO IS NOT IN CHANNEL 3, PLEASE CHANGE ACCCORDINGLY</span></span>
<span id="cb12-58"><a href="data-wrangling.html#cb12-58" aria-hidden="true" tabindex="-1"></a>  first_moving_mat <span class="ot">&lt;-</span></span>
<span id="cb12-59"><a href="data-wrangling.html#cb12-59" aria-hidden="true" tabindex="-1"></a>    mat_import[[stringr<span class="sc">::</span><span class="fu">str_which</span>(<span class="fu">names</span>(mat_import), <span class="st">&quot;Ch3&quot;</span>)[<span class="dv">1</span>]]][[<span class="dv">5</span>]][,<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb12-60"><a href="data-wrangling.html#cb12-60" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find the first &quot;moving&quot; phase in the log file</span></span>
<span id="cb12-61"><a href="data-wrangling.html#cb12-61" aria-hidden="true" tabindex="-1"></a>  first_moving_csv <span class="ot">&lt;-</span></span>
<span id="cb12-62"><a href="data-wrangling.html#cb12-62" aria-hidden="true" tabindex="-1"></a>    csv_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb12-63"><a href="data-wrangling.html#cb12-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Trial <span class="sc">==</span> <span class="st">&quot;moving&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-64"><a href="data-wrangling.html#cb12-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb12-65"><a href="data-wrangling.html#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-66"><a href="data-wrangling.html#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb12-67"><a href="data-wrangling.html#cb12-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find the first &quot;blank&quot; phase in the log file</span></span>
<span id="cb12-68"><a href="data-wrangling.html#cb12-68" aria-hidden="true" tabindex="-1"></a>  first_blank <span class="ot">&lt;-</span></span>
<span id="cb12-69"><a href="data-wrangling.html#cb12-69" aria-hidden="true" tabindex="-1"></a>    csv_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb12-70"><a href="data-wrangling.html#cb12-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Trial <span class="sc">==</span> <span class="st">&quot;blank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-71"><a href="data-wrangling.html#cb12-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb12-72"><a href="data-wrangling.html#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-73"><a href="data-wrangling.html#cb12-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb12-74"><a href="data-wrangling.html#cb12-74" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Compute the difference between these two</span></span>
<span id="cb12-75"><a href="data-wrangling.html#cb12-75" aria-hidden="true" tabindex="-1"></a>  first_mvbl_diff <span class="ot">&lt;-</span> first_moving_csv <span class="sc">-</span> first_blank</span>
<span id="cb12-76"><a href="data-wrangling.html#cb12-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-77"><a href="data-wrangling.html#cb12-77" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Check to see if the final row of the metadata is &quot;moving&quot; and truncate</span></span>
<span id="cb12-78"><a href="data-wrangling.html#cb12-78" aria-hidden="true" tabindex="-1"></a>  <span class="do">## if not</span></span>
<span id="cb12-79"><a href="data-wrangling.html#cb12-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">## This can effectively be done by truncating after the final &quot;moving&quot; phase</span></span>
<span id="cb12-80"><a href="data-wrangling.html#cb12-80" aria-hidden="true" tabindex="-1"></a>  max_moving_sweep <span class="ot">&lt;-</span></span>
<span id="cb12-81"><a href="data-wrangling.html#cb12-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(<span class="fu">which</span>(csv_data_sets[[i]]<span class="sc">$</span>Trial <span class="sc">==</span> <span class="st">&quot;moving&quot;</span>))</span>
<span id="cb12-82"><a href="data-wrangling.html#cb12-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-83"><a href="data-wrangling.html#cb12-83" aria-hidden="true" tabindex="-1"></a>  first_csv_tmp <span class="ot">&lt;-</span></span>
<span id="cb12-84"><a href="data-wrangling.html#cb12-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(initial, csv_data_sets[[i]]) <span class="sc">%&gt;%</span></span>
<span id="cb12-85"><a href="data-wrangling.html#cb12-85" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Add 1 to max moving sweep since we tacked on &quot;initial&quot; in previous step</span></span>
<span id="cb12-86"><a href="data-wrangling.html#cb12-86" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Then slice to restrict any extraneous partial sweeps</span></span>
<span id="cb12-87"><a href="data-wrangling.html#cb12-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_head</span>(<span class="at">n =</span> (max_moving_sweep <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-88"><a href="data-wrangling.html#cb12-88" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Add the first event time to &quot;Time&quot; and subtract first_mvbl_diff (~2 secs)</span></span>
<span id="cb12-89"><a href="data-wrangling.html#cb12-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time =</span> Time <span class="sc">+</span> first_moving_mat <span class="sc">-</span> first_mvbl_diff <span class="sc">-</span> first_blank) <span class="sc">%&gt;%</span></span>
<span id="cb12-90"><a href="data-wrangling.html#cb12-90" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Make character version of Time for joining later</span></span>
<span id="cb12-91"><a href="data-wrangling.html#cb12-91" aria-hidden="true" tabindex="-1"></a>    <span class="do">## This will be crucial for _join functions</span></span>
<span id="cb12-92"><a href="data-wrangling.html#cb12-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time,<span class="dv">3</span>)))</span>
<span id="cb12-93"><a href="data-wrangling.html#cb12-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-94"><a href="data-wrangling.html#cb12-94" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Duplicate the initialization for ease of setting T0</span></span>
<span id="cb12-95"><a href="data-wrangling.html#cb12-95" aria-hidden="true" tabindex="-1"></a>  inception <span class="ot">&lt;-</span></span>
<span id="cb12-96"><a href="data-wrangling.html#cb12-96" aria-hidden="true" tabindex="-1"></a>    initial <span class="sc">%&gt;%</span></span>
<span id="cb12-97"><a href="data-wrangling.html#cb12-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time,<span class="dv">3</span>)))</span>
<span id="cb12-98"><a href="data-wrangling.html#cb12-98" aria-hidden="true" tabindex="-1"></a>  inception<span class="sc">$</span>Trial[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;inception&quot;</span></span>
<span id="cb12-99"><a href="data-wrangling.html#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="data-wrangling.html#cb12-100" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Bind the initialization rows</span></span>
<span id="cb12-101"><a href="data-wrangling.html#cb12-101" aria-hidden="true" tabindex="-1"></a>  first_csv <span class="ot">&lt;-</span></span>
<span id="cb12-102"><a href="data-wrangling.html#cb12-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(inception, first_csv_tmp)</span>
<span id="cb12-103"><a href="data-wrangling.html#cb12-103" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Compute stimulus end times</span></span>
<span id="cb12-104"><a href="data-wrangling.html#cb12-104" aria-hidden="true" tabindex="-1"></a>  first_csv<span class="sc">$</span>Stim_end <span class="ot">&lt;-</span> <span class="fu">c</span>(first_csv<span class="sc">$</span>Time[<span class="sc">-</span><span class="dv">1</span>], <span class="fu">max</span>(first_csv<span class="sc">$</span>Time) <span class="sc">+</span> <span class="dv">3</span>)</span>
<span id="cb12-105"><a href="data-wrangling.html#cb12-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-106"><a href="data-wrangling.html#cb12-106" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Get final time</span></span>
<span id="cb12-107"><a href="data-wrangling.html#cb12-107" aria-hidden="true" tabindex="-1"></a>  final_time <span class="ot">&lt;-</span> first_csv<span class="sc">$</span>Stim_end[<span class="fu">nrow</span>(first_csv)]</span>
<span id="cb12-108"><a href="data-wrangling.html#cb12-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-109"><a href="data-wrangling.html#cb12-109" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find photodiode</span></span>
<span id="cb12-110"><a href="data-wrangling.html#cb12-110" aria-hidden="true" tabindex="-1"></a>  <span class="do">## It is almost always in channel 2, but we should be sure to check before</span></span>
<span id="cb12-111"><a href="data-wrangling.html#cb12-111" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extracting automatically</span></span>
<span id="cb12-112"><a href="data-wrangling.html#cb12-112" aria-hidden="true" tabindex="-1"></a>  photod_default_channel <span class="ot">&lt;-</span></span>
<span id="cb12-113"><a href="data-wrangling.html#cb12-113" aria-hidden="true" tabindex="-1"></a>    mat_import[[stringr<span class="sc">::</span><span class="fu">str_which</span>(<span class="fu">names</span>(mat_import), <span class="st">&quot;Ch2&quot;</span>)[<span class="dv">1</span>]]]</span>
<span id="cb12-114"><a href="data-wrangling.html#cb12-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>photod_default_channel[<span class="dv">1</span>][[<span class="dv">1</span>]][<span class="dv">1</span>] <span class="sc">==</span> <span class="st">&quot;waveform&quot;</span>) {</span>
<span id="cb12-115"><a href="data-wrangling.html#cb12-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;File &quot;</span>, i,<span class="st">&quot;: Photodiode channel identity uncertain&quot;</span>)</span>
<span id="cb12-116"><a href="data-wrangling.html#cb12-116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-117"><a href="data-wrangling.html#cb12-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-118"><a href="data-wrangling.html#cb12-118" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find spikes</span></span>
<span id="cb12-119"><a href="data-wrangling.html#cb12-119" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Similarly, spikes are almost always in channel 5, but we should check</span></span>
<span id="cb12-120"><a href="data-wrangling.html#cb12-120" aria-hidden="true" tabindex="-1"></a>  spikes_default_channel <span class="ot">&lt;-</span></span>
<span id="cb12-121"><a href="data-wrangling.html#cb12-121" aria-hidden="true" tabindex="-1"></a>    mat_import[[stringr<span class="sc">::</span><span class="fu">str_which</span>(<span class="fu">names</span>(mat_import), <span class="st">&quot;Ch5&quot;</span>)[<span class="dv">1</span>]]]</span>
<span id="cb12-122"><a href="data-wrangling.html#cb12-122" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;codes&quot;</span> <span class="sc">%not_in%</span> <span class="fu">attributes</span>(spikes_default_channel)<span class="sc">$</span>dimnames[[<span class="dv">1</span>]]) {</span>
<span id="cb12-123"><a href="data-wrangling.html#cb12-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;File &quot;</span>, i,<span class="st">&quot;: Sorted spikes channel identity uncertain&quot;</span>)</span>
<span id="cb12-124"><a href="data-wrangling.html#cb12-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-125"><a href="data-wrangling.html#cb12-125" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If that worked, see if we can automatically determine the &quot;times&quot; and</span></span>
<span id="cb12-126"><a href="data-wrangling.html#cb12-126" aria-hidden="true" tabindex="-1"></a>  <span class="do">## &quot;codes&quot; slot numbers</span></span>
<span id="cb12-127"><a href="data-wrangling.html#cb12-127" aria-hidden="true" tabindex="-1"></a>  times_location <span class="ot">&lt;-</span></span>
<span id="cb12-128"><a href="data-wrangling.html#cb12-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(<span class="fu">attributes</span>(spikes_default_channel)<span class="sc">$</span>dimnames[[<span class="dv">1</span>]] <span class="sc">==</span> <span class="st">&quot;times&quot;</span>)</span>
<span id="cb12-129"><a href="data-wrangling.html#cb12-129" aria-hidden="true" tabindex="-1"></a>  codes_location <span class="ot">&lt;-</span></span>
<span id="cb12-130"><a href="data-wrangling.html#cb12-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(<span class="fu">attributes</span>(spikes_default_channel)<span class="sc">$</span>dimnames[[<span class="dv">1</span>]] <span class="sc">==</span> <span class="st">&quot;codes&quot;</span>)</span>
<span id="cb12-131"><a href="data-wrangling.html#cb12-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-132"><a href="data-wrangling.html#cb12-132" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extract photodiode data</span></span>
<span id="cb12-133"><a href="data-wrangling.html#cb12-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb12-134"><a href="data-wrangling.html#cb12-134" aria-hidden="true" tabindex="-1"></a>  photod_full <span class="ot">&lt;-</span></span>
<span id="cb12-135"><a href="data-wrangling.html#cb12-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb12-136"><a href="data-wrangling.html#cb12-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">Photod =</span></span>
<span id="cb12-137"><a href="data-wrangling.html#cb12-137" aria-hidden="true" tabindex="-1"></a>        photod_default_channel[<span class="dv">9</span>][[<span class="dv">1</span>]][, <span class="dv">1</span>])</span>
<span id="cb12-138"><a href="data-wrangling.html#cb12-138" aria-hidden="true" tabindex="-1"></a>  photod_full<span class="sc">$</span>Time <span class="ot">&lt;-</span></span>
<span id="cb12-139"><a href="data-wrangling.html#cb12-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(</span>
<span id="cb12-140"><a href="data-wrangling.html#cb12-140" aria-hidden="true" tabindex="-1"></a>      <span class="at">from =</span> <span class="dv">0</span>,</span>
<span id="cb12-141"><a href="data-wrangling.html#cb12-141" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">25000</span>,</span>
<span id="cb12-142"><a href="data-wrangling.html#cb12-142" aria-hidden="true" tabindex="-1"></a>      <span class="at">length.out =</span> <span class="fu">nrow</span>(photod_full)</span>
<span id="cb12-143"><a href="data-wrangling.html#cb12-143" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-144"><a href="data-wrangling.html#cb12-144" aria-hidden="true" tabindex="-1"></a>  photod_full <span class="ot">&lt;-</span></span>
<span id="cb12-145"><a href="data-wrangling.html#cb12-145" aria-hidden="true" tabindex="-1"></a>    photod_full <span class="sc">%&gt;%</span></span>
<span id="cb12-146"><a href="data-wrangling.html#cb12-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time, <span class="dv">5</span>)))</span>
<span id="cb12-147"><a href="data-wrangling.html#cb12-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-148"><a href="data-wrangling.html#cb12-148" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extract all spike data</span></span>
<span id="cb12-149"><a href="data-wrangling.html#cb12-149" aria-hidden="true" tabindex="-1"></a>  all_spike_dat <span class="ot">&lt;-</span></span>
<span id="cb12-150"><a href="data-wrangling.html#cb12-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb12-151"><a href="data-wrangling.html#cb12-151" aria-hidden="true" tabindex="-1"></a>      <span class="at">Time =</span></span>
<span id="cb12-152"><a href="data-wrangling.html#cb12-152" aria-hidden="true" tabindex="-1"></a>        spikes_default_channel[times_location][[<span class="dv">1</span>]][, <span class="dv">1</span>],</span>
<span id="cb12-153"><a href="data-wrangling.html#cb12-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">code =</span></span>
<span id="cb12-154"><a href="data-wrangling.html#cb12-154" aria-hidden="true" tabindex="-1"></a>        spikes_default_channel[codes_location][[<span class="dv">1</span>]][, <span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb12-155"><a href="data-wrangling.html#cb12-155" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Get rid of empty rows</span></span>
<span id="cb12-156"><a href="data-wrangling.html#cb12-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(code <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-157"><a href="data-wrangling.html#cb12-157" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Characterize time, for purposes of joining later</span></span>
<span id="cb12-158"><a href="data-wrangling.html#cb12-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time, <span class="dv">5</span>))) <span class="co">#%&gt;%</span></span>
<span id="cb12-159"><a href="data-wrangling.html#cb12-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mutate(code = as.character(code))</span></span>
<span id="cb12-160"><a href="data-wrangling.html#cb12-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-161"><a href="data-wrangling.html#cb12-161" aria-hidden="true" tabindex="-1"></a>  <span class="do">## How many distinct neurons are there?</span></span>
<span id="cb12-162"><a href="data-wrangling.html#cb12-162" aria-hidden="true" tabindex="-1"></a>  n_cells <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(all_spike_dat<span class="sc">$</span>code))</span>
<span id="cb12-163"><a href="data-wrangling.html#cb12-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-164"><a href="data-wrangling.html#cb12-164" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(n_cells) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb12-165"><a href="data-wrangling.html#cb12-165" aria-hidden="true" tabindex="-1"></a>    all_spike_dat_tmp <span class="ot">&lt;-</span></span>
<span id="cb12-166"><a href="data-wrangling.html#cb12-166" aria-hidden="true" tabindex="-1"></a>      all_spike_dat <span class="sc">%&gt;%</span></span>
<span id="cb12-167"><a href="data-wrangling.html#cb12-167" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Group by identity of spiking neuron</span></span>
<span id="cb12-168"><a href="data-wrangling.html#cb12-168" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb12-169"><a href="data-wrangling.html#cb12-169" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Split into separate dfs, one per neuron</span></span>
<span id="cb12-170"><a href="data-wrangling.html#cb12-170" aria-hidden="true" tabindex="-1"></a>      <span class="co">#split(factor(all_spike_dat$code))</span></span>
<span id="cb12-171"><a href="data-wrangling.html#cb12-171" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_split</span>()</span>
<span id="cb12-172"><a href="data-wrangling.html#cb12-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-173"><a href="data-wrangling.html#cb12-173" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Keep the name of the first cell&#39;s spike column as simply &quot;Spikes&quot;</span></span>
<span id="cb12-174"><a href="data-wrangling.html#cb12-174" aria-hidden="true" tabindex="-1"></a>    first_cell <span class="ot">&lt;-</span></span>
<span id="cb12-175"><a href="data-wrangling.html#cb12-175" aria-hidden="true" tabindex="-1"></a>      all_spike_dat_tmp[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb12-176"><a href="data-wrangling.html#cb12-176" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">Spikes =</span> code)</span>
<span id="cb12-177"><a href="data-wrangling.html#cb12-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-178"><a href="data-wrangling.html#cb12-178" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Additional cells are labeled as &quot;Spike_n&quot;</span></span>
<span id="cb12-179"><a href="data-wrangling.html#cb12-179" aria-hidden="true" tabindex="-1"></a>    ad_cells <span class="ot">&lt;-</span> n_cells[n_cells <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb12-180"><a href="data-wrangling.html#cb12-180" aria-hidden="true" tabindex="-1"></a>    all_cells <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-181"><a href="data-wrangling.html#cb12-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> ad_cells) {</span>
<span id="cb12-182"><a href="data-wrangling.html#cb12-182" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(i)</span></span>
<span id="cb12-183"><a href="data-wrangling.html#cb12-183" aria-hidden="true" tabindex="-1"></a>      new_name <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;Spikes_&quot;</span>, j)</span>
<span id="cb12-184"><a href="data-wrangling.html#cb12-184" aria-hidden="true" tabindex="-1"></a>      all_cells[[j]] <span class="ot">&lt;-</span></span>
<span id="cb12-185"><a href="data-wrangling.html#cb12-185" aria-hidden="true" tabindex="-1"></a>        all_spike_dat_tmp[[j]]</span>
<span id="cb12-186"><a href="data-wrangling.html#cb12-186" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(all_cells[[j]])[<span class="fu">match</span>(<span class="st">&quot;code&quot;</span>, <span class="fu">names</span>(all_cells[[j]]))] <span class="ot">&lt;-</span></span>
<span id="cb12-187"><a href="data-wrangling.html#cb12-187" aria-hidden="true" tabindex="-1"></a>        new_name</span>
<span id="cb12-188"><a href="data-wrangling.html#cb12-188" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-189"><a href="data-wrangling.html#cb12-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-190"><a href="data-wrangling.html#cb12-190" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Add first cell back in</span></span>
<span id="cb12-191"><a href="data-wrangling.html#cb12-191" aria-hidden="true" tabindex="-1"></a>    all_cells[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> first_cell</span>
<span id="cb12-192"><a href="data-wrangling.html#cb12-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-193"><a href="data-wrangling.html#cb12-193" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Consolidate</span></span>
<span id="cb12-194"><a href="data-wrangling.html#cb12-194" aria-hidden="true" tabindex="-1"></a>    all_spike_dat <span class="ot">&lt;-</span></span>
<span id="cb12-195"><a href="data-wrangling.html#cb12-195" aria-hidden="true" tabindex="-1"></a>      all_cells <span class="sc">%&gt;%</span></span>
<span id="cb12-196"><a href="data-wrangling.html#cb12-196" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Tack on additional spike columns</span></span>
<span id="cb12-197"><a href="data-wrangling.html#cb12-197" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-198"><a href="data-wrangling.html#cb12-198" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Remove time.n columns but</span></span>
<span id="cb12-199"><a href="data-wrangling.html#cb12-199" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Do not remove Time_char</span></span>
<span id="cb12-200"><a href="data-wrangling.html#cb12-200" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">&quot;Time.&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-201"><a href="data-wrangling.html#cb12-201" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Regenerate numeric time</span></span>
<span id="cb12-202"><a href="data-wrangling.html#cb12-202" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb12-203"><a href="data-wrangling.html#cb12-203" aria-hidden="true" tabindex="-1"></a>        <span class="at">Time =</span> <span class="fu">as.numeric</span>(Time_char)</span>
<span id="cb12-204"><a href="data-wrangling.html#cb12-204" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb12-205"><a href="data-wrangling.html#cb12-205" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(Time, Time_char, <span class="fu">everything</span>())</span>
<span id="cb12-206"><a href="data-wrangling.html#cb12-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-207"><a href="data-wrangling.html#cb12-207" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-208"><a href="data-wrangling.html#cb12-208" aria-hidden="true" tabindex="-1"></a>    all_spike_dat <span class="ot">&lt;-</span></span>
<span id="cb12-209"><a href="data-wrangling.html#cb12-209" aria-hidden="true" tabindex="-1"></a>      all_spike_dat <span class="sc">%&gt;%</span></span>
<span id="cb12-210"><a href="data-wrangling.html#cb12-210" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">Spikes =</span> code) <span class="sc">%&gt;%</span></span>
<span id="cb12-211"><a href="data-wrangling.html#cb12-211" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(Time, Time_char, <span class="fu">everything</span>())</span>
<span id="cb12-212"><a href="data-wrangling.html#cb12-212" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-213"><a href="data-wrangling.html#cb12-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-214"><a href="data-wrangling.html#cb12-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb12-215"><a href="data-wrangling.html#cb12-215" aria-hidden="true" tabindex="-1"></a>  mat_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-216"><a href="data-wrangling.html#cb12-216" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Generate a time sequence from 0 to final_time</span></span>
<span id="cb12-217"><a href="data-wrangling.html#cb12-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb12-218"><a href="data-wrangling.html#cb12-218" aria-hidden="true" tabindex="-1"></a>      <span class="at">Time =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> final_time, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb12-219"><a href="data-wrangling.html#cb12-219" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-220"><a href="data-wrangling.html#cb12-220" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Character-ize it</span></span>
<span id="cb12-221"><a href="data-wrangling.html#cb12-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time, <span class="dv">5</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb12-222"><a href="data-wrangling.html#cb12-222" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Join in the photodiode data</span></span>
<span id="cb12-223"><a href="data-wrangling.html#cb12-223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(photod_full, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-224"><a href="data-wrangling.html#cb12-224" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Time.y) <span class="sc">%&gt;%</span></span>
<span id="cb12-225"><a href="data-wrangling.html#cb12-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Time =</span> Time.x) <span class="sc">%&gt;%</span></span>
<span id="cb12-226"><a href="data-wrangling.html#cb12-226" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Join in the spike data</span></span>
<span id="cb12-227"><a href="data-wrangling.html#cb12-227" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(all_spike_dat, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-228"><a href="data-wrangling.html#cb12-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Time.y) <span class="sc">%&gt;%</span></span>
<span id="cb12-229"><a href="data-wrangling.html#cb12-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Time =</span> Time.x) <span class="sc">%&gt;%</span></span>
<span id="cb12-230"><a href="data-wrangling.html#cb12-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> final_time) <span class="sc">%&gt;%</span></span>
<span id="cb12-231"><a href="data-wrangling.html#cb12-231" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Replace NAs with 0 in the Spike columns only</span></span>
<span id="cb12-232"><a href="data-wrangling.html#cb12-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-233"><a href="data-wrangling.html#cb12-233" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;Spikes&quot;</span>), <span class="sc">~</span><span class="fu">replace_na</span>(.x, <span class="dv">0</span>))</span>
<span id="cb12-234"><a href="data-wrangling.html#cb12-234" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-235"><a href="data-wrangling.html#cb12-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-236"><a href="data-wrangling.html#cb12-236" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Merge the matlab data with the metadata</span></span>
<span id="cb12-237"><a href="data-wrangling.html#cb12-237" aria-hidden="true" tabindex="-1"></a>  joined_one_full <span class="ot">&lt;-</span></span>
<span id="cb12-238"><a href="data-wrangling.html#cb12-238" aria-hidden="true" tabindex="-1"></a>    mat_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb12-239"><a href="data-wrangling.html#cb12-239" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Join by the character version of time NOT the numerical!!</span></span>
<span id="cb12-240"><a href="data-wrangling.html#cb12-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">full_join</span>(first_csv, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-241"><a href="data-wrangling.html#cb12-241" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Rename columns for clarity of reference</span></span>
<span id="cb12-242"><a href="data-wrangling.html#cb12-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Time_mat =</span> Time.x,</span>
<span id="cb12-243"><a href="data-wrangling.html#cb12-243" aria-hidden="true" tabindex="-1"></a>           <span class="at">Time_csv =</span> Time.y) <span class="sc">%&gt;%</span></span>
<span id="cb12-244"><a href="data-wrangling.html#cb12-244" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Convert character time to numeric time</span></span>
<span id="cb12-245"><a href="data-wrangling.html#cb12-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time =</span> <span class="fu">as.numeric</span>(Time_char)) <span class="sc">%&gt;%</span></span>
<span id="cb12-246"><a href="data-wrangling.html#cb12-246" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Carry metadata forward</span></span>
<span id="cb12-247"><a href="data-wrangling.html#cb12-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-248"><a href="data-wrangling.html#cb12-248" aria-hidden="true" tabindex="-1"></a>      <span class="at">Trial =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Trial, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb12-249"><a href="data-wrangling.html#cb12-249" aria-hidden="true" tabindex="-1"></a>      <span class="at">Spatial_Frequency =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Spatial_Frequency, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb12-250"><a href="data-wrangling.html#cb12-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">SF_cpd =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(SF_cpd, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb12-251"><a href="data-wrangling.html#cb12-251" aria-hidden="true" tabindex="-1"></a>      <span class="at">Temporal_Frequency =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Temporal_Frequency, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb12-252"><a href="data-wrangling.html#cb12-252" aria-hidden="true" tabindex="-1"></a>      <span class="at">Direction =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Direction, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb12-253"><a href="data-wrangling.html#cb12-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">Time_csv =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Time_csv, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb12-254"><a href="data-wrangling.html#cb12-254" aria-hidden="true" tabindex="-1"></a>      <span class="at">Stim_end =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Stim_end, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>)</span>
<span id="cb12-255"><a href="data-wrangling.html#cb12-255" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-256"><a href="data-wrangling.html#cb12-256" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Calculate velocity</span></span>
<span id="cb12-257"><a href="data-wrangling.html#cb12-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-258"><a href="data-wrangling.html#cb12-258" aria-hidden="true" tabindex="-1"></a>      <span class="at">Speed =</span> Temporal_Frequency<span class="sc">/</span>SF_cpd,</span>
<span id="cb12-259"><a href="data-wrangling.html#cb12-259" aria-hidden="true" tabindex="-1"></a>      <span class="at">Log2_Speed =</span> <span class="fu">log2</span>(Speed)</span>
<span id="cb12-260"><a href="data-wrangling.html#cb12-260" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-261"><a href="data-wrangling.html#cb12-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-262"><a href="data-wrangling.html#cb12-262" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Add info to metadata</span></span>
<span id="cb12-263"><a href="data-wrangling.html#cb12-263" aria-hidden="true" tabindex="-1"></a>  metadata_one_full <span class="ot">&lt;-</span></span>
<span id="cb12-264"><a href="data-wrangling.html#cb12-264" aria-hidden="true" tabindex="-1"></a>    first_csv <span class="sc">%&gt;%</span></span>
<span id="cb12-265"><a href="data-wrangling.html#cb12-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-266"><a href="data-wrangling.html#cb12-266" aria-hidden="true" tabindex="-1"></a>      <span class="at">Speed =</span> Temporal_Frequency<span class="sc">/</span>SF_cpd,</span>
<span id="cb12-267"><a href="data-wrangling.html#cb12-267" aria-hidden="true" tabindex="-1"></a>      <span class="at">Log2_Speed =</span> <span class="fu">log2</span>(Speed),</span>
<span id="cb12-268"><a href="data-wrangling.html#cb12-268" aria-hidden="true" tabindex="-1"></a>      <span class="at">Stim_end_diff =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(Stim_end))</span>
<span id="cb12-269"><a href="data-wrangling.html#cb12-269" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-270"><a href="data-wrangling.html#cb12-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-271"><a href="data-wrangling.html#cb12-271" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Some quality control checks</span></span>
<span id="cb12-272"><a href="data-wrangling.html#cb12-272" aria-hidden="true" tabindex="-1"></a>  <span class="do">## What are the stim time differences?</span></span>
<span id="cb12-273"><a href="data-wrangling.html#cb12-273" aria-hidden="true" tabindex="-1"></a>  stimtime_diffs <span class="ot">&lt;-</span> <span class="fu">round</span>(metadata_one_full<span class="sc">$</span>Stim_end_diff)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span>
<span id="cb12-274"><a href="data-wrangling.html#cb12-274" aria-hidden="true" tabindex="-1"></a>  <span class="do">## How many total reps were recorded?</span></span>
<span id="cb12-275"><a href="data-wrangling.html#cb12-275" aria-hidden="true" tabindex="-1"></a>  stimtime_reps <span class="ot">&lt;-</span> <span class="fu">length</span>(stimtime_diffs)<span class="sc">/</span><span class="dv">3</span></span>
<span id="cb12-276"><a href="data-wrangling.html#cb12-276" aria-hidden="true" tabindex="-1"></a>  <span class="do">## What do we expect the overall structure to look like?</span></span>
<span id="cb12-277"><a href="data-wrangling.html#cb12-277" aria-hidden="true" tabindex="-1"></a>  stimtime_expectation <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>), stimtime_reps)</span>
<span id="cb12-278"><a href="data-wrangling.html#cb12-278" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Does reality match our expectations?</span></span>
<span id="cb12-279"><a href="data-wrangling.html#cb12-279" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(stimtime_diffs <span class="sc">==</span> stimtime_expectation)) {</span>
<span id="cb12-280"><a href="data-wrangling.html#cb12-280" aria-hidden="true" tabindex="-1"></a>    <span class="do">## If you get this, investigate the file further and determine what went</span></span>
<span id="cb12-281"><a href="data-wrangling.html#cb12-281" aria-hidden="true" tabindex="-1"></a>    <span class="do">## wrong</span></span>
<span id="cb12-282"><a href="data-wrangling.html#cb12-282" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;stimtime issue; investigate&quot;</span>)</span>
<span id="cb12-283"><a href="data-wrangling.html#cb12-283" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-284"><a href="data-wrangling.html#cb12-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-285"><a href="data-wrangling.html#cb12-285" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Sometimes the final sweep gets carried for an indefinite amount of time</span></span>
<span id="cb12-286"><a href="data-wrangling.html#cb12-286" aria-hidden="true" tabindex="-1"></a>  <span class="do">## before the investigator manually shuts things off. The following block</span></span>
<span id="cb12-287"><a href="data-wrangling.html#cb12-287" aria-hidden="true" tabindex="-1"></a>  <span class="do">## truncates accordingly</span></span>
<span id="cb12-288"><a href="data-wrangling.html#cb12-288" aria-hidden="true" tabindex="-1"></a>  mark_for_removal <span class="ot">&lt;-</span></span>
<span id="cb12-289"><a href="data-wrangling.html#cb12-289" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(<span class="fu">round</span>(metadata_one_full<span class="sc">$</span>Stim_end_diff) <span class="sc">%not_in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb12-290"><a href="data-wrangling.html#cb12-290" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(mark_for_removal <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> mark_for_removal <span class="sc">==</span> <span class="dv">2</span>)) {</span>
<span id="cb12-291"><a href="data-wrangling.html#cb12-291" aria-hidden="true" tabindex="-1"></a>    mark_for_removal <span class="ot">&lt;-</span> mark_for_removal[mark_for_removal <span class="sc">&gt;</span> <span class="dv">2</span>]</span>
<span id="cb12-292"><a href="data-wrangling.html#cb12-292" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-293"><a href="data-wrangling.html#cb12-293" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(mark_for_removal) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb12-294"><a href="data-wrangling.html#cb12-294" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-295"><a href="data-wrangling.html#cb12-295" aria-hidden="true" tabindex="-1"></a>      metadata_one_full <span class="sc">%&gt;%</span></span>
<span id="cb12-296"><a href="data-wrangling.html#cb12-296" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Time <span class="sc">&lt;</span> metadata_one_full[mark_for_removal[<span class="dv">1</span>],]<span class="sc">$</span>Time)</span>
<span id="cb12-297"><a href="data-wrangling.html#cb12-297" aria-hidden="true" tabindex="-1"></a>    joined_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-298"><a href="data-wrangling.html#cb12-298" aria-hidden="true" tabindex="-1"></a>      joined_one_full <span class="sc">%&gt;%</span></span>
<span id="cb12-299"><a href="data-wrangling.html#cb12-299" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Time_mat <span class="sc">&lt;</span> metadata_one_full[mark_for_removal[<span class="dv">1</span>],]<span class="sc">$</span>Time)</span>
<span id="cb12-300"><a href="data-wrangling.html#cb12-300" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-301"><a href="data-wrangling.html#cb12-301" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-302"><a href="data-wrangling.html#cb12-302" aria-hidden="true" tabindex="-1"></a>      metadata_one_full</span>
<span id="cb12-303"><a href="data-wrangling.html#cb12-303" aria-hidden="true" tabindex="-1"></a>    joined_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-304"><a href="data-wrangling.html#cb12-304" aria-hidden="true" tabindex="-1"></a>      joined_one_full</span>
<span id="cb12-305"><a href="data-wrangling.html#cb12-305" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-306"><a href="data-wrangling.html#cb12-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-307"><a href="data-wrangling.html#cb12-307" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Organize the metadata for export in the R environment</span></span>
<span id="cb12-308"><a href="data-wrangling.html#cb12-308" aria-hidden="true" tabindex="-1"></a>  meta_splits[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-309"><a href="data-wrangling.html#cb12-309" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb12-310"><a href="data-wrangling.html#cb12-310" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Get rid of the non-sweep info</span></span>
<span id="cb12-311"><a href="data-wrangling.html#cb12-311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;inception&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-312"><a href="data-wrangling.html#cb12-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;initialization&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-313"><a href="data-wrangling.html#cb12-313" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Group by trial</span></span>
<span id="cb12-314"><a href="data-wrangling.html#cb12-314" aria-hidden="true" tabindex="-1"></a>    <span class="co">#group_by(Spatial_Frequency, Temporal_Frequency, Direction) %&gt;%</span></span>
<span id="cb12-315"><a href="data-wrangling.html#cb12-315" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Split by trial group</span></span>
<span id="cb12-316"><a href="data-wrangling.html#cb12-316" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_split</span>(Spatial_Frequency, Temporal_Frequency, Direction)</span>
<span id="cb12-317"><a href="data-wrangling.html#cb12-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-318"><a href="data-wrangling.html#cb12-318" aria-hidden="true" tabindex="-1"></a>  data_splits[[i]] <span class="ot">&lt;-</span></span>
<span id="cb12-319"><a href="data-wrangling.html#cb12-319" aria-hidden="true" tabindex="-1"></a>    joined_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb12-320"><a href="data-wrangling.html#cb12-320" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Get rid of the non-sweep info</span></span>
<span id="cb12-321"><a href="data-wrangling.html#cb12-321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;inception&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-322"><a href="data-wrangling.html#cb12-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;initialization&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-323"><a href="data-wrangling.html#cb12-323" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Group by trial</span></span>
<span id="cb12-324"><a href="data-wrangling.html#cb12-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Spatial_Frequency, Temporal_Frequency, Direction) <span class="sc">%&gt;%</span></span>
<span id="cb12-325"><a href="data-wrangling.html#cb12-325" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Split by trial group</span></span>
<span id="cb12-326"><a href="data-wrangling.html#cb12-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_split</span>()</span>
<span id="cb12-327"><a href="data-wrangling.html#cb12-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-328"><a href="data-wrangling.html#cb12-328" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Do some cleanup so large objects don&#39;t linger in memory</span></span>
<span id="cb12-329"><a href="data-wrangling.html#cb12-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(</span>
<span id="cb12-330"><a href="data-wrangling.html#cb12-330" aria-hidden="true" tabindex="-1"></a>    first_csv, inception, initial, mat_import, first_csv_tmp,</span>
<span id="cb12-331"><a href="data-wrangling.html#cb12-331" aria-hidden="true" tabindex="-1"></a>    photod_default_channel, spikes_default_channel, photod_full,</span>
<span id="cb12-332"><a href="data-wrangling.html#cb12-332" aria-hidden="true" tabindex="-1"></a>    all_spike_dat, all_spike_dat_tmp, first_cell, all_cells,</span>
<span id="cb12-333"><a href="data-wrangling.html#cb12-333" aria-hidden="true" tabindex="-1"></a>    metadata_one_full, joined_one_full, joined_data_sets,</span>
<span id="cb12-334"><a href="data-wrangling.html#cb12-334" aria-hidden="true" tabindex="-1"></a>    csv_data_sets, mat_data_sets</span>
<span id="cb12-335"><a href="data-wrangling.html#cb12-335" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-336"><a href="data-wrangling.html#cb12-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;File &quot;</span>, i, <span class="st">&quot;: &quot;</span>, csv_mat_filejoin[i,<span class="st">&quot;basename&quot;</span>], <span class="st">&quot; imported&quot;</span>)</span>
<span id="cb12-337"><a href="data-wrangling.html#cb12-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb12-338"><a href="data-wrangling.html#cb12-338" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="data-wrangling.html#cb14-1" aria-hidden="true" tabindex="-1"></a>endtime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb14-2"><a href="data-wrangling.html#cb14-2" aria-hidden="true" tabindex="-1"></a>endtime <span class="sc">-</span> starttime <span class="do">## Total elapsed time</span></span></code></pre></div>
<pre><code>## Time difference of 2.17167 mins</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="data-wrangling.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Tidy up</span></span>
<span id="cb16-2"><a href="data-wrangling.html#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##            used  (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells  4099736 219.0   70153405 3746.6  40649002 2170.9
## Vcells 44152332 336.9  460320359 3512.0 719156848 5486.8</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="data-wrangling.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Name each data set according to the basename of the file</span></span>
<span id="cb18-2"><a href="data-wrangling.html#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(metadata_sets) <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span>
<span id="cb18-3"><a href="data-wrangling.html#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(meta_splits)   <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span>
<span id="cb18-4"><a href="data-wrangling.html#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_splits)   <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span>
<span id="cb18-5"><a href="data-wrangling.html#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="data-wrangling.html#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Get organized lists of stimuli that were used</span></span>
<span id="cb18-7"><a href="data-wrangling.html#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="do">## This will ultimately be used for arranging data by stimuli in a sensible</span></span>
<span id="cb18-8"><a href="data-wrangling.html#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="do">## order</span></span>
<span id="cb18-9"><a href="data-wrangling.html#cb18-9" aria-hidden="true" tabindex="-1"></a>metadata_combos <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb18-10"><a href="data-wrangling.html#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(metadata_sets)) {</span>
<span id="cb18-11"><a href="data-wrangling.html#cb18-11" aria-hidden="true" tabindex="-1"></a>  metadata_combos[[i]] <span class="ot">&lt;-</span></span>
<span id="cb18-12"><a href="data-wrangling.html#cb18-12" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb18-13"><a href="data-wrangling.html#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Get unique stimulus parameters</span></span>
<span id="cb18-14"><a href="data-wrangling.html#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(SF_cpd, Temporal_Frequency, Speed, Direction) <span class="sc">%&gt;%</span></span>
<span id="cb18-15"><a href="data-wrangling.html#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Direction) <span class="sc">%&gt;%</span></span>
<span id="cb18-16"><a href="data-wrangling.html#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Sort by SF_cpd (smallest to largest)</span></span>
<span id="cb18-17"><a href="data-wrangling.html#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(SF_cpd)) <span class="sc">%&gt;%</span></span>
<span id="cb18-18"><a href="data-wrangling.html#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-19"><a href="data-wrangling.html#cb18-19" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Set a &quot;plot_order&quot; which provides a running order of stimuli</span></span>
<span id="cb18-20"><a href="data-wrangling.html#cb18-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot_order =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(meta_splits[[i]]),</span>
<span id="cb18-21"><a href="data-wrangling.html#cb18-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">paste</span>(Direction, <span class="st">&quot;Deg,&quot;</span>,  Speed, <span class="st">&quot;Deg/s&quot;</span>)</span>
<span id="cb18-22"><a href="data-wrangling.html#cb18-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-23"><a href="data-wrangling.html#cb18-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-24"><a href="data-wrangling.html#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(metadata_combos) <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span></code></pre></div>
<p><strong>What we now have is the following:</strong></p>
<ul>
<li><code>metadata_sets</code>: contains a <code>list</code> of <code>tibble</code>s (one per imported file),
each of which comprises the stimulus log</li>
<li><code>metadata_combos</code>: contains a <code>list</code> of <code>tibble</code>s (one per imported file),
each of which comprises the stimulus log re-written in a preferred plotting
order</li>
<li><code>meta_splits</code>: a <code>list</code> of <code>list</code>s. The first level of the <code>list</code>
corresponds to the file identities. Within each file’s <code>list</code>, there is an
additional set of <code>list</code>s, each of which contains a <code>tibble</code> with the log
info for a specific stimulus combination. Essentially the same as
<code>metadata_sets</code> but split up on a per-stimulus basis.</li>
<li><code>data_splits</code>: another <code>list</code> of <code>list</code>s, arranged in the same hierarchical
order as <code>meta_splits</code>. Each tibble herein contains the spike and photodiode
data from the <code>matlab</code> file on a per-stimulus basis.</li>
</ul>
<p>Note that since we are only using one example file, each of these lists should
only be 1 element long (with the latter two having additional elements within
the first element)</p>
</div>
</div>
<div id="organizing-replicates-required-and-binning-optional" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Organizing replicates (required) and binning (optional)<a href="data-wrangling.html#organizing-replicates-required-and-binning-optional" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>It is common to record several different sweeps of a stimulus to collect
(somewhat) independent replicates of neural responses. The primary task of this
section will be to use the lists from the previous section to gather &amp; label
replicates of the same stimulus.</p>
<p>A secondary task is to deal with binning, if desired (highly recommended).
Depending on the goals of plotting and/or analyses, it may be wise to work with
either unbinned spike data or to bin the data at a convenient and sensible
interval. I generally choose to work at the following levels:</p>
<ol style="list-style-type: decimal">
<li>Unbinned</li>
<li>Bin size = 10 ms</li>
<li>Bin size = 100 ms</li>
</ol>
<p><strong>Important note:</strong> Rather than provide separate code for each of these 3
scenarios, I will provide one example. Bin size <strong>must</strong> be declared beforehand
– please pay attention.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="data-wrangling.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set bin size here</span></span>
<span id="cb19-2"><a href="data-wrangling.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Units are in ms (e.g. 10 = 10ms)</span></span>
<span id="cb19-3"><a href="data-wrangling.html#cb19-3" aria-hidden="true" tabindex="-1"></a>bin_size <span class="ot">=</span> <span class="dv">10</span> <span class="do">## 10 or 100 or 1 (1 = &quot;unbinned&quot;)</span></span>
<span id="cb19-4"><a href="data-wrangling.html#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="data-wrangling.html#cb19-5" aria-hidden="true" tabindex="-1"></a>slice_size <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb19-6"><a href="data-wrangling.html#cb19-6" aria-hidden="true" tabindex="-1"></a>slicemin <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb19-7"><a href="data-wrangling.html#cb19-7" aria-hidden="true" tabindex="-1"></a>slicemax <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb19-8"><a href="data-wrangling.html#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (bin_size <span class="sc">==</span> <span class="dv">10</span>){</span>
<span id="cb19-9"><a href="data-wrangling.html#cb19-9" aria-hidden="true" tabindex="-1"></a>  slice_size <span class="ot">&lt;-</span> <span class="dv">501</span></span>
<span id="cb19-10"><a href="data-wrangling.html#cb19-10" aria-hidden="true" tabindex="-1"></a>  slicemin <span class="ot">&lt;-</span> <span class="dv">202</span></span>
<span id="cb19-11"><a href="data-wrangling.html#cb19-11" aria-hidden="true" tabindex="-1"></a>  slicemax <span class="ot">&lt;-</span> <span class="dv">498</span></span>
<span id="cb19-12"><a href="data-wrangling.html#cb19-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (bin_size <span class="sc">==</span> <span class="dv">100</span>){</span>
<span id="cb19-13"><a href="data-wrangling.html#cb19-13" aria-hidden="true" tabindex="-1"></a>  slice_size <span class="ot">&lt;-</span> <span class="dv">51</span></span>
<span id="cb19-14"><a href="data-wrangling.html#cb19-14" aria-hidden="true" tabindex="-1"></a>  slicemin <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb19-15"><a href="data-wrangling.html#cb19-15" aria-hidden="true" tabindex="-1"></a>  slicemax <span class="ot">&lt;-</span> <span class="dv">49</span></span>
<span id="cb19-16"><a href="data-wrangling.html#cb19-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (bin_size <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb19-17"><a href="data-wrangling.html#cb19-17" aria-hidden="true" tabindex="-1"></a>  slice_size <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-18"><a href="data-wrangling.html#cb19-18" aria-hidden="true" tabindex="-1"></a>  slicemin <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-19"><a href="data-wrangling.html#cb19-19" aria-hidden="true" tabindex="-1"></a>  slicemax <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-20"><a href="data-wrangling.html#cb19-20" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb19-21"><a href="data-wrangling.html#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;bin_size is non-standard&quot;</span>)</span>
<span id="cb19-22"><a href="data-wrangling.html#cb19-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-23"><a href="data-wrangling.html#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="data-wrangling.html#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="data-wrangling.html#cb19-25" aria-hidden="true" tabindex="-1"></a>all_replicate_data_reorganized <span class="ot">&lt;-</span></span>
<span id="cb19-26"><a href="data-wrangling.html#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="at">length =</span> <span class="fu">length</span>(meta_splits))</span>
<span id="cb19-27"><a href="data-wrangling.html#cb19-27" aria-hidden="true" tabindex="-1"></a>name_sets <span class="ot">&lt;-</span></span>
<span id="cb19-28"><a href="data-wrangling.html#cb19-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="at">length =</span> <span class="fu">length</span>(meta_splits))</span>
<span id="cb19-29"><a href="data-wrangling.html#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##            used  (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells  4102631 219.2   56122724 2997.3  40649002 2170.9
## Vcells 44151491 336.9  368256288 2809.6 719156848 5486.8</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="data-wrangling.html#cb21-1" aria-hidden="true" tabindex="-1"></a>starttime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb21-2"><a href="data-wrangling.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(meta_splits)){</span>
<span id="cb21-3"><a href="data-wrangling.html#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="data-wrangling.html#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## i = file number</span></span>
<span id="cb21-5"><a href="data-wrangling.html#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb21-6"><a href="data-wrangling.html#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="data-wrangling.html#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## We&#39;ll need to collect data at a per-stimulus level and on a per-replicate</span></span>
<span id="cb21-8"><a href="data-wrangling.html#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## level within the per-stimulus level</span></span>
<span id="cb21-9"><a href="data-wrangling.html#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## &quot;j&quot; will be used to designate a unique stimulus</span></span>
<span id="cb21-10"><a href="data-wrangling.html#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## We&#39;ll first create an empty object in which to collect stimulus-specific</span></span>
<span id="cb21-11"><a href="data-wrangling.html#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## data</span></span>
<span id="cb21-12"><a href="data-wrangling.html#cb21-12" aria-hidden="true" tabindex="-1"></a>  replicate_data_reorganized <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-13"><a href="data-wrangling.html#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For each of j unique stimuli...</span></span>
<span id="cb21-14"><a href="data-wrangling.html#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(meta_splits[[i]])) { <span class="co"># j = {direction,speed}</span></span>
<span id="cb21-15"><a href="data-wrangling.html#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Isolate the j-th data</span></span>
<span id="cb21-16"><a href="data-wrangling.html#cb21-16" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> data_splits[[i]][[j]]</span>
<span id="cb21-17"><a href="data-wrangling.html#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="do">## And the j-th log data</span></span>
<span id="cb21-18"><a href="data-wrangling.html#cb21-18" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> meta_splits[[i]][[j]] <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="data-wrangling.html#cb21-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Trial) <span class="sc">%&gt;%</span></span>
<span id="cb21-20"><a href="data-wrangling.html#cb21-20" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Label separate replicates</span></span>
<span id="cb21-21"><a href="data-wrangling.html#cb21-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Replicate =</span> <span class="fu">row_number</span>())</span>
<span id="cb21-22"><a href="data-wrangling.html#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="data-wrangling.html#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract a stimulus label to a name_set that will be used later</span></span>
<span id="cb21-24"><a href="data-wrangling.html#cb21-24" aria-hidden="true" tabindex="-1"></a>    name_sets[[i]][[j]] <span class="ot">&lt;-</span></span>
<span id="cb21-25"><a href="data-wrangling.html#cb21-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(m<span class="sc">$</span>Direction[<span class="dv">1</span>], <span class="st">&quot;Deg,&quot;</span>,  m<span class="sc">$</span>Speed[<span class="dv">1</span>], <span class="st">&quot;Deg/s&quot;</span>)</span>
<span id="cb21-26"><a href="data-wrangling.html#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="data-wrangling.html#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Set up a temporary object to deal with per-replicate data</span></span>
<span id="cb21-28"><a href="data-wrangling.html#cb21-28" aria-hidden="true" tabindex="-1"></a>    replicates_ordered <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-29"><a href="data-wrangling.html#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="do">## &quot;k&quot; will be used to designate replicate number</span></span>
<span id="cb21-30"><a href="data-wrangling.html#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(m<span class="sc">$</span>Replicate)){</span>
<span id="cb21-31"><a href="data-wrangling.html#cb21-31" aria-hidden="true" tabindex="-1"></a>      tmp <span class="ot">&lt;-</span></span>
<span id="cb21-32"><a href="data-wrangling.html#cb21-32" aria-hidden="true" tabindex="-1"></a>        m <span class="sc">%&gt;%</span></span>
<span id="cb21-33"><a href="data-wrangling.html#cb21-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Replicate <span class="sc">==</span> k)</span>
<span id="cb21-34"><a href="data-wrangling.html#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="data-wrangling.html#cb21-35" aria-hidden="true" tabindex="-1"></a>      <span class="do">## If you have a complete replicate (i.e., blank, stationary, moving)</span></span>
<span id="cb21-36"><a href="data-wrangling.html#cb21-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(tmp) <span class="sc">==</span> <span class="dv">3</span> ) {</span>
<span id="cb21-37"><a href="data-wrangling.html#cb21-37" aria-hidden="true" tabindex="-1"></a>        <span class="do">## Grab the specific data</span></span>
<span id="cb21-38"><a href="data-wrangling.html#cb21-38" aria-hidden="true" tabindex="-1"></a>        doot <span class="ot">&lt;-</span></span>
<span id="cb21-39"><a href="data-wrangling.html#cb21-39" aria-hidden="true" tabindex="-1"></a>          d <span class="sc">%&gt;%</span></span>
<span id="cb21-40"><a href="data-wrangling.html#cb21-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(Time <span class="sc">&gt;=</span> <span class="fu">min</span>(tmp<span class="sc">$</span>Time)) <span class="sc">%&gt;%</span></span>
<span id="cb21-41"><a href="data-wrangling.html#cb21-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> <span class="fu">max</span>(tmp<span class="sc">$</span>Stim_end))</span>
<span id="cb21-42"><a href="data-wrangling.html#cb21-42" aria-hidden="true" tabindex="-1"></a>        <span class="do">## Add bin information</span></span>
<span id="cb21-43"><a href="data-wrangling.html#cb21-43" aria-hidden="true" tabindex="-1"></a>        doot<span class="sc">$</span>bin <span class="ot">&lt;-</span></span>
<span id="cb21-44"><a href="data-wrangling.html#cb21-44" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ceiling</span>(<span class="fu">nrow</span>(doot)<span class="sc">/</span>bin_size), <span class="at">each =</span> bin_size)[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(doot)]</span>
<span id="cb21-45"><a href="data-wrangling.html#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="data-wrangling.html#cb21-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(bin_size <span class="sc">==</span> <span class="dv">1</span>) { <span class="do">## IF YOU ARE NOT BINNING, RUN THIS:</span></span>
<span id="cb21-47"><a href="data-wrangling.html#cb21-47" aria-hidden="true" tabindex="-1"></a>          replicates_ordered[[k]] <span class="ot">&lt;-</span></span>
<span id="cb21-48"><a href="data-wrangling.html#cb21-48" aria-hidden="true" tabindex="-1"></a>            doot <span class="sc">%&gt;%</span></span>
<span id="cb21-49"><a href="data-wrangling.html#cb21-49" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb21-50"><a href="data-wrangling.html#cb21-50" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Construct a standardized time within the sweep</span></span>
<span id="cb21-51"><a href="data-wrangling.html#cb21-51" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_stand =</span> Time_mat <span class="sc">-</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb21-52"><a href="data-wrangling.html#cb21-52" aria-hidden="true" tabindex="-1"></a>              <span class="do">## When does the sweep begin</span></span>
<span id="cb21-53"><a href="data-wrangling.html#cb21-53" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_begin =</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb21-54"><a href="data-wrangling.html#cb21-54" aria-hidden="true" tabindex="-1"></a>              <span class="do">## When does the sweep end</span></span>
<span id="cb21-55"><a href="data-wrangling.html#cb21-55" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_end =</span> <span class="fu">max</span>(Time_mat),</span>
<span id="cb21-56"><a href="data-wrangling.html#cb21-56" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Delineate the end of the blank phase</span></span>
<span id="cb21-57"><a href="data-wrangling.html#cb21-57" aria-hidden="true" tabindex="-1"></a>              <span class="at">Blank_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb21-58"><a href="data-wrangling.html#cb21-58" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Delineate the end of the stationary phase</span></span>
<span id="cb21-59"><a href="data-wrangling.html#cb21-59" aria-hidden="true" tabindex="-1"></a>              <span class="at">Static_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb21-60"><a href="data-wrangling.html#cb21-60" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Label the replicate number</span></span>
<span id="cb21-61"><a href="data-wrangling.html#cb21-61" aria-hidden="true" tabindex="-1"></a>              <span class="at">Replicate =</span> k</span>
<span id="cb21-62"><a href="data-wrangling.html#cb21-62" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb21-63"><a href="data-wrangling.html#cb21-63" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Bring stim info to first few columns</span></span>
<span id="cb21-64"><a href="data-wrangling.html#cb21-64" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(Speed, SF_cpd, Temporal_Frequency, Direction,</span>
<span id="cb21-65"><a href="data-wrangling.html#cb21-65" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb21-66"><a href="data-wrangling.html#cb21-66" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Just in case there some hang over</span></span>
<span id="cb21-67"><a href="data-wrangling.html#cb21-67" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(Time_stand <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb21-68"><a href="data-wrangling.html#cb21-68" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> { <span class="do">## IF YOU ARE BINNING, RUN THIS:</span></span>
<span id="cb21-69"><a href="data-wrangling.html#cb21-69" aria-hidden="true" tabindex="-1"></a>          replicates_ordered[[k]] <span class="ot">&lt;-</span></span>
<span id="cb21-70"><a href="data-wrangling.html#cb21-70" aria-hidden="true" tabindex="-1"></a>            doot <span class="sc">%&gt;%</span></span>
<span id="cb21-71"><a href="data-wrangling.html#cb21-71" aria-hidden="true" tabindex="-1"></a>            <span class="do">## WITHIN EACH BIN:</span></span>
<span id="cb21-72"><a href="data-wrangling.html#cb21-72" aria-hidden="true" tabindex="-1"></a>            <span class="fu">group_by</span>(bin) <span class="sc">%&gt;%</span></span>
<span id="cb21-73"><a href="data-wrangling.html#cb21-73" aria-hidden="true" tabindex="-1"></a>            <span class="fu">summarise</span>(</span>
<span id="cb21-74"><a href="data-wrangling.html#cb21-74" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Label the trial</span></span>
<span id="cb21-75"><a href="data-wrangling.html#cb21-75" aria-hidden="true" tabindex="-1"></a>              <span class="at">Trial =</span> <span class="fu">first</span>(Trial),</span>
<span id="cb21-76"><a href="data-wrangling.html#cb21-76" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Midpoint of bin</span></span>
<span id="cb21-77"><a href="data-wrangling.html#cb21-77" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_bin_mid =</span> <span class="fu">mean</span>(Time_mat),</span>
<span id="cb21-78"><a href="data-wrangling.html#cb21-78" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Bin beginning</span></span>
<span id="cb21-79"><a href="data-wrangling.html#cb21-79" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_bin_begin =</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb21-80"><a href="data-wrangling.html#cb21-80" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Bin end</span></span>
<span id="cb21-81"><a href="data-wrangling.html#cb21-81" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_bin_end =</span> <span class="fu">max</span>(Time_mat),</span>
<span id="cb21-82"><a href="data-wrangling.html#cb21-82" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Spike rate = sum of spikes divided by elapsed time</span></span>
<span id="cb21-83"><a href="data-wrangling.html#cb21-83" aria-hidden="true" tabindex="-1"></a>              <span class="at">Spike_rate =</span> <span class="fu">sum</span>(Spikes)<span class="sc">/</span>(<span class="fu">max</span>(Time_mat) <span class="sc">-</span> <span class="fu">min</span>(Time_mat)),</span>
<span id="cb21-84"><a href="data-wrangling.html#cb21-84" aria-hidden="true" tabindex="-1"></a>              <span class="at">Photod_mean =</span> <span class="fu">mean</span>(Photod)</span>
<span id="cb21-85"><a href="data-wrangling.html#cb21-85" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb21-86"><a href="data-wrangling.html#cb21-86" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb21-87"><a href="data-wrangling.html#cb21-87" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Add in metadata (following same definitions above)</span></span>
<span id="cb21-88"><a href="data-wrangling.html#cb21-88" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_stand =</span> Time_bin_mid <span class="sc">-</span> <span class="fu">min</span>(Time_bin_mid),</span>
<span id="cb21-89"><a href="data-wrangling.html#cb21-89" aria-hidden="true" tabindex="-1"></a>              <span class="at">Blank_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_bin_mid),</span>
<span id="cb21-90"><a href="data-wrangling.html#cb21-90" aria-hidden="true" tabindex="-1"></a>              <span class="at">Static_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_bin_mid),</span>
<span id="cb21-91"><a href="data-wrangling.html#cb21-91" aria-hidden="true" tabindex="-1"></a>              <span class="at">SF_cpd =</span> m<span class="sc">$</span>SF_cpd[<span class="dv">1</span>],</span>
<span id="cb21-92"><a href="data-wrangling.html#cb21-92" aria-hidden="true" tabindex="-1"></a>              <span class="at">Temporal_Frequency =</span> m<span class="sc">$</span>Temporal_Frequency[<span class="dv">1</span>],</span>
<span id="cb21-93"><a href="data-wrangling.html#cb21-93" aria-hidden="true" tabindex="-1"></a>              <span class="at">Speed =</span> m<span class="sc">$</span>Speed[<span class="dv">1</span>],</span>
<span id="cb21-94"><a href="data-wrangling.html#cb21-94" aria-hidden="true" tabindex="-1"></a>              <span class="at">Direction =</span> m<span class="sc">$</span>Direction[<span class="dv">1</span>],</span>
<span id="cb21-95"><a href="data-wrangling.html#cb21-95" aria-hidden="true" tabindex="-1"></a>              <span class="at">Replicate =</span> k</span>
<span id="cb21-96"><a href="data-wrangling.html#cb21-96" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb21-97"><a href="data-wrangling.html#cb21-97" aria-hidden="true" tabindex="-1"></a>            <span class="do">## Bring stim info to first few columns</span></span>
<span id="cb21-98"><a href="data-wrangling.html#cb21-98" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(Speed, SF_cpd, Temporal_Frequency, Direction,</span>
<span id="cb21-99"><a href="data-wrangling.html#cb21-99" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb21-100"><a href="data-wrangling.html#cb21-100" aria-hidden="true" tabindex="-1"></a>            <span class="do">## Just in case there some hang over</span></span>
<span id="cb21-101"><a href="data-wrangling.html#cb21-101" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(Time_stand <span class="sc">&gt;=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-102"><a href="data-wrangling.html#cb21-102" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(bin <span class="sc">&lt;</span> slice_size <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb21-103"><a href="data-wrangling.html#cb21-103" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-104"><a href="data-wrangling.html#cb21-104" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-105"><a href="data-wrangling.html#cb21-105" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-106"><a href="data-wrangling.html#cb21-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-107"><a href="data-wrangling.html#cb21-107" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Now insert it within the collector of per-stimulus data</span></span>
<span id="cb21-108"><a href="data-wrangling.html#cb21-108" aria-hidden="true" tabindex="-1"></a>    replicate_data_reorganized[[j]] <span class="ot">&lt;-</span></span>
<span id="cb21-109"><a href="data-wrangling.html#cb21-109" aria-hidden="true" tabindex="-1"></a>      replicates_ordered <span class="sc">%&gt;%</span></span>
<span id="cb21-110"><a href="data-wrangling.html#cb21-110" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>()</span>
<span id="cb21-111"><a href="data-wrangling.html#cb21-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-112"><a href="data-wrangling.html#cb21-112" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Now insert it within the overall data collector</span></span>
<span id="cb21-113"><a href="data-wrangling.html#cb21-113" aria-hidden="true" tabindex="-1"></a>    all_replicate_data_reorganized[[i]][[j]] <span class="ot">&lt;-</span></span>
<span id="cb21-114"><a href="data-wrangling.html#cb21-114" aria-hidden="true" tabindex="-1"></a>      replicate_data_reorganized[[j]]</span>
<span id="cb21-115"><a href="data-wrangling.html#cb21-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-116"><a href="data-wrangling.html#cb21-116" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Toss out temporary object and clean up</span></span>
<span id="cb21-117"><a href="data-wrangling.html#cb21-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(replicates_ordered)</span>
<span id="cb21-118"><a href="data-wrangling.html#cb21-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb21-119"><a href="data-wrangling.html#cb21-119" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-120"><a href="data-wrangling.html#cb21-120" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="data-wrangling.html#cb23-1" aria-hidden="true" tabindex="-1"></a>endtime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb23-2"><a href="data-wrangling.html#cb23-2" aria-hidden="true" tabindex="-1"></a>endtime <span class="sc">-</span> starttime</span></code></pre></div>
<pre><code>## Time difference of 1.142881 mins</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="data-wrangling.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##            used  (Mb) gc trigger   (Mb)  max used   (Mb)
## Ncells  4108999 219.5   11769790  628.6  40649002 2170.9
## Vcells 46342110 353.6  150837776 1150.9 719156848 5486.8</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="data-wrangling.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_replicate_data_reorganized)) {</span>
<span id="cb27-2"><a href="data-wrangling.html#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_replicate_data_reorganized[[i]])) {</span>
<span id="cb27-3"><a href="data-wrangling.html#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(all_replicate_data_reorganized[[i]])[[j]] <span class="ot">&lt;-</span> name_sets[[i]][[j]]</span>
<span id="cb27-4"><a href="data-wrangling.html#cb27-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-5"><a href="data-wrangling.html#cb27-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-6"><a href="data-wrangling.html#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(all_replicate_data_reorganized) <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span></code></pre></div>
</div>
<div id="data-export" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Data export<a href="data-wrangling.html#data-export" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>It is highly recommended that you export <code>all_replicate_data_reorganized</code>. I
generally export <code>all_replicate_data_reorganized</code> as a separate <code>csv</code> file for
each of the following conditions:</p>
<ol style="list-style-type: decimal">
<li>Unbinned</li>
<li>Bin size = 10 ms</li>
<li>Bin size = 100 ms</li>
</ol>
<p>This section will provide code to export each of the above, assuming you used
those bin sizes in the previous section. Please be sure to change file naming
conventions and other parameters in the event you chose a different <code>bin_size</code>
in the previous section.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="data-wrangling.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Declare export destination</span></span>
<span id="cb28-2"><a href="data-wrangling.html#cb28-2" aria-hidden="true" tabindex="-1"></a>export_path <span class="ot">&lt;-</span> <span class="st">&quot;./data/&quot;</span></span>
<span id="cb28-3"><a href="data-wrangling.html#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="do">## The &quot;condition&quot; will be appended to the file name. Choose whichever one</span></span>
<span id="cb28-4"><a href="data-wrangling.html#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="do">## corresponds to the bin_size you used above</span></span>
<span id="cb28-5"><a href="data-wrangling.html#cb28-5" aria-hidden="true" tabindex="-1"></a>condition <span class="ot">&lt;-</span>  <span class="st">&quot;_binsize10&quot;</span></span>
<span id="cb28-6"><a href="data-wrangling.html#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">#condition &lt;-  &quot;_binsize100&quot;</span></span>
<span id="cb28-7"><a href="data-wrangling.html#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">#condition &lt;-  &quot;_unbinned&quot;</span></span>
<span id="cb28-8"><a href="data-wrangling.html#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="data-wrangling.html#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Export each tibble within all_replicate_data_reorganized</span></span>
<span id="cb28-10"><a href="data-wrangling.html#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_replicate_data_reorganized)) {</span>
<span id="cb28-11"><a href="data-wrangling.html#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb28-12"><a href="data-wrangling.html#cb28-12" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span></span>
<span id="cb28-13"><a href="data-wrangling.html#cb28-13" aria-hidden="true" tabindex="-1"></a>    all_replicate_data_reorganized[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb28-14"><a href="data-wrangling.html#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb28-15"><a href="data-wrangling.html#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(</span>
<span id="cb28-16"><a href="data-wrangling.html#cb28-16" aria-hidden="true" tabindex="-1"></a>    dat,</span>
<span id="cb28-17"><a href="data-wrangling.html#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span></span>
<span id="cb28-18"><a href="data-wrangling.html#cb28-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(</span>
<span id="cb28-19"><a href="data-wrangling.html#cb28-19" aria-hidden="true" tabindex="-1"></a>        export_path,</span>
<span id="cb28-20"><a href="data-wrangling.html#cb28-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(all_replicate_data_reorganized)[i],</span>
<span id="cb28-21"><a href="data-wrangling.html#cb28-21" aria-hidden="true" tabindex="-1"></a>        condition,</span>
<span id="cb28-22"><a href="data-wrangling.html#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;.csv&quot;</span></span>
<span id="cb28-23"><a href="data-wrangling.html#cb28-23" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-24"><a href="data-wrangling.html#cb28-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-25"><a href="data-wrangling.html#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(dat)</span>
<span id="cb28-26"><a href="data-wrangling.html#cb28-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Re-run the above chunk of code per condition you seek to export</p>
<p>🐢</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="raw-data-and-spike-sorted-traces.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="raster-and-mean-spike-rate-plots.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/04-data_wrangling.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>

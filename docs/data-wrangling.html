<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Data wrangling | Fundamental plots for electrophysiological data</title>
  <meta name="description" content="<p>A walkthrough on how to produce fundamental plots from electrophysiological
data. Developed by the Alshuler Lab at the University of British Columbia.</p>" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Data wrangling | Fundamental plots for electrophysiological data" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="<p>A walkthrough on how to produce fundamental plots from electrophysiological
data. Developed by the Alshuler Lab at the University of British Columbia.</p>" />
  <meta name="github-repo" content="flightlab/ephys_fundamental_plots" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Data wrangling | Fundamental plots for electrophysiological data" />
  
  <meta name="twitter:description" content="<p>A walkthrough on how to produce fundamental plots from electrophysiological
data. Developed by the Alshuler Lab at the University of British Columbia.</p>" />
  

<meta name="author" content="Vikram B. Baliga" />


<meta name="date" content="2023-03-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="raw-data-and-spike-sorted-traces.html"/>
<link rel="next" href="raster-and-mean-spike-rate-plots.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Fundamental plots for electrophysiological data</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#citation"><i class="fa fa-check"></i>Citation</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i><b>2</b> Preface</a>
<ul>
<li class="chapter" data-level="2.1" data-path="preface.html"><a href="preface.html#r-packages-versioning"><i class="fa fa-check"></i><b>2.1</b> R packages &amp; versioning</a></li>
<li class="chapter" data-level="2.2" data-path="preface.html"><a href="preface.html#not_in"><i class="fa fa-check"></i><b>2.2</b> <code>%not_in%</code></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spike-sorting.html"><a href="spike-sorting.html"><i class="fa fa-check"></i><b>3</b> Spike sorting</a>
<ul>
<li class="chapter" data-level="3.1" data-path="spike-sorting.html"><a href="spike-sorting.html#spike2"><i class="fa fa-check"></i><b>3.1</b> Spike2</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="spike-sorting.html"><a href="spike-sorting.html#file-naming-conventions"><i class="fa fa-check"></i><b>3.1.1</b> File naming conventions:</a></li>
<li class="chapter" data-level="3.1.2" data-path="spike-sorting.html"><a href="spike-sorting.html#spike-sorting-with-spike2"><i class="fa fa-check"></i><b>3.1.2</b> Spike sorting with Spike2</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spike-sorting.html"><a href="spike-sorting.html#neuralynx"><i class="fa fa-check"></i><b>3.2</b> Neuralynx</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="raw-data-and-spike-sorted-traces.html"><a href="raw-data-and-spike-sorted-traces.html"><i class="fa fa-check"></i><b>4</b> Raw data and spike sorted traces</a></li>
<li class="chapter" data-level="5" data-path="data-wrangling.html"><a href="data-wrangling.html"><i class="fa fa-check"></i><b>5</b> Data wrangling</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-wrangling.html"><a href="data-wrangling.html#import-example-file-and-metadata"><i class="fa fa-check"></i><b>5.1</b> Import example file and metadata</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="data-wrangling.html"><a href="data-wrangling.html#identify-files-to-import"><i class="fa fa-check"></i><b>5.1.1</b> Identify files to import</a></li>
<li class="chapter" data-level="5.1.2" data-path="data-wrangling.html"><a href="data-wrangling.html#data-import-and-preliminary-labeling"><i class="fa fa-check"></i><b>5.1.2</b> Data import and preliminary labeling</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data-wrangling.html"><a href="data-wrangling.html#organizing-replicates-required-and-binning-optional"><i class="fa fa-check"></i><b>5.2</b> Organizing replicates (required) and binning (optional)</a></li>
<li class="chapter" data-level="5.3" data-path="data-wrangling.html"><a href="data-wrangling.html#data-export"><i class="fa fa-check"></i><b>5.3</b> Data export</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="raster-and-mean-spike-rate-plots.html"><a href="raster-and-mean-spike-rate-plots.html"><i class="fa fa-check"></i><b>6</b> Raster and mean spike rate plots</a>
<ul>
<li class="chapter" data-level="6.1" data-path="raster-and-mean-spike-rate-plots.html"><a href="raster-and-mean-spike-rate-plots.html#data-sets"><i class="fa fa-check"></i><b>6.1</b> Data sets</a></li>
<li class="chapter" data-level="6.2" data-path="raster-and-mean-spike-rate-plots.html"><a href="raster-and-mean-spike-rate-plots.html#raster-plot"><i class="fa fa-check"></i><b>6.2</b> Raster plot</a></li>
<li class="chapter" data-level="6.3" data-path="raster-and-mean-spike-rate-plots.html"><a href="raster-and-mean-spike-rate-plots.html#mean-spike-rate-plots"><i class="fa fa-check"></i><b>6.3</b> Mean spike rate plots</a></li>
<li class="chapter" data-level="6.4" data-path="raster-and-mean-spike-rate-plots.html"><a href="raster-and-mean-spike-rate-plots.html#export-to-pdf"><i class="fa fa-check"></i><b>6.4</b> Export to PDF</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="direction-tuning.html"><a href="direction-tuning.html"><i class="fa fa-check"></i><b>7</b> Direction tuning</a>
<ul>
<li class="chapter" data-level="7.1" data-path="direction-tuning.html"><a href="direction-tuning.html#data-import-and-baseline-rate-measurement"><i class="fa fa-check"></i><b>7.1</b> Data import and baseline rate measurement</a></li>
<li class="chapter" data-level="7.2" data-path="direction-tuning.html"><a href="direction-tuning.html#using-the-full-3-sec-motion-epoch"><i class="fa fa-check"></i><b>7.2</b> Using the full 3-sec motion epoch</a></li>
<li class="chapter" data-level="7.3" data-path="direction-tuning.html"><a href="direction-tuning.html#using-40-200ms-initial-transient"><i class="fa fa-check"></i><b>7.3</b> Using 40-200ms (“initial transient”)</a></li>
<li class="chapter" data-level="7.4" data-path="direction-tuning.html"><a href="direction-tuning.html#using-1500-3000ms-steady-state"><i class="fa fa-check"></i><b>7.4</b> Using 1500-3000ms (“steady state”)</a></li>
<li class="chapter" data-level="7.5" data-path="direction-tuning.html"><a href="direction-tuning.html#using-0-500-ms-arbitrary-epoch-length"><i class="fa fa-check"></i><b>7.5</b> Using 0-500 ms (arbitrary epoch length)</a></li>
<li class="chapter" data-level="7.6" data-path="direction-tuning.html"><a href="direction-tuning.html#construct-a-multi-panel-plot"><i class="fa fa-check"></i><b>7.6</b> Construct a multi-panel plot</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="spatiotemporal-tuning.html"><a href="spatiotemporal-tuning.html"><i class="fa fa-check"></i><b>8</b> Spatiotemporal tuning</a></li>
<li class="chapter" data-level="9" data-path="histological-verification.html"><a href="histological-verification.html"><i class="fa fa-check"></i><b>9</b> Histological verification</a>
<ul>
<li class="chapter" data-level="9.0.1" data-path="histological-verification.html"><a href="histological-verification.html#direct-embedding-method"><i class="fa fa-check"></i><b>9.0.1</b> Direct embedding method:</a></li>
<li class="chapter" data-level="9.0.2" data-path="histological-verification.html"><a href="histological-verification.html#hotlinking-method"><i class="fa fa-check"></i><b>9.0.2</b> Hotlinking method:</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fundamental plots for electrophysiological data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-wrangling" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">5</span> Data wrangling<a href="data-wrangling.html#data-wrangling" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Once data have been spike sorted, we are ready to begin working in
<code>R</code>. To get to a point where meaningful preliminary plots can be
produced, a few things need to be addressed:</p>
<ol style="list-style-type: decimal">
<li><p>Labeling the time series of spike &amp; photodiode data based on the
stimulus that appears on screen (i.e., matching the log file to
the data file). This includes labeling phases (like “blank”,
“stationary”, and “moving”) along with experimental metadata such
as SF, TF, and stimulus orientation (direction).</p></li>
<li><p>Re-organizing the spike &amp; photodiode so that separate replicates
of a stimulus run are uniquely labelled and then arranged
together.</p></li>
<li><p>Binning the data into 10- and 100-ms data sets, and then exporting
CSVs of the unbinned, 10-ms-binned, and 100-ms-binned data. This
will be highly useful for situations where you are handling
multiple data files (e.g., from different recording days), in
which case it is likely that your machine will not be able to
store all objects in RAM.</p></li>
</ol>
<blockquote>
<p>Before proceeding any further, please ensure you have installed and
loaded all the necessary <code>R</code> packages as detailed in the Preface
section of this guide.</p>
</blockquote>
<div id="import-example-file-and-metadata" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Import example file and metadata<a href="data-wrangling.html#import-example-file-and-metadata" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will use a recently-collected data file and its corresponding
metadata file to showcase the fundamentals of wrangling ephys data
into a more easily plot-able format.</p>
<div id="identify-files-to-import" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Identify files to import<a href="data-wrangling.html#identify-files-to-import" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following code is based on the assumptions that:</p>
<ol style="list-style-type: decimal">
<li><p>Your files are stored in a directory entitled <code>/data</code></p></li>
<li><p>The basename of each file (i.e., the name of the file, excluding the file
extension) is identical for each set of spike sorted data and corresponding
metadata log file (e.g., <code>2023-02-16_001.mat</code> and <code>2023-02-16_001.csv</code> have the
same basename, which is <code>2023-02-16_001</code>).</p></li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="data-wrangling.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## List all files of each file type</span></span>
<span id="cb4-2"><a href="data-wrangling.html#cb4-2" aria-hidden="true" tabindex="-1"></a>csv_files <span class="ot">&lt;-</span></span>
<span id="cb4-3"><a href="data-wrangling.html#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="st">&quot;./data&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;.csv&quot;</span>,</span>
<span id="cb4-4"><a href="data-wrangling.html#cb4-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-5"><a href="data-wrangling.html#cb4-5" aria-hidden="true" tabindex="-1"></a>mat_files <span class="ot">&lt;-</span></span>
<span id="cb4-6"><a href="data-wrangling.html#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="st">&quot;./data&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;.mat&quot;</span>,</span>
<span id="cb4-7"><a href="data-wrangling.html#cb4-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-8"><a href="data-wrangling.html#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="data-wrangling.html#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Generate metadata tibbles for each file type</span></span>
<span id="cb4-10"><a href="data-wrangling.html#cb4-10" aria-hidden="true" tabindex="-1"></a>csv_file_info <span class="ot">&lt;-</span></span>
<span id="cb4-11"><a href="data-wrangling.html#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb4-12"><a href="data-wrangling.html#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">csv_files =</span> csv_files,</span>
<span id="cb4-13"><a href="data-wrangling.html#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract the basename by removing the file extension</span></span>
<span id="cb4-14"><a href="data-wrangling.html#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">basename =</span>  <span class="fu">basename</span>(csv_files) <span class="sc">%&gt;%</span> <span class="fu">str_remove</span>(<span class="st">&quot;.csv&quot;</span>),</span>
<span id="cb4-15"><a href="data-wrangling.html#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="do">## </span><span class="al">NOTE</span><span class="do">: PLEASE ADJUST THE FOLLOWING LINE TO BE ABLE TO EXCTRACT OUT THE</span></span>
<span id="cb4-16"><a href="data-wrangling.html#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">## DATE BASED ON YOUR NAMING CONVENTION</span></span>
<span id="cb4-17"><a href="data-wrangling.html#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">basedate =</span>  <span class="fu">basename</span>(csv_files) <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(<span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">12</span>)</span>
<span id="cb4-18"><a href="data-wrangling.html#cb4-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-19"><a href="data-wrangling.html#cb4-19" aria-hidden="true" tabindex="-1"></a>mat_file_info <span class="ot">&lt;-</span></span>
<span id="cb4-20"><a href="data-wrangling.html#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb4-21"><a href="data-wrangling.html#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">mat_files =</span> mat_files,</span>
<span id="cb4-22"><a href="data-wrangling.html#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract the basename by removing the file extension</span></span>
<span id="cb4-23"><a href="data-wrangling.html#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">basename =</span>  <span class="fu">basename</span>(mat_files) <span class="sc">%&gt;%</span> <span class="fu">str_remove</span>(<span class="st">&quot;.mat&quot;</span>),</span>
<span id="cb4-24"><a href="data-wrangling.html#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="do">## </span><span class="al">NOTE</span><span class="do">: AGAIN, PLEASE ADJUST THE FOLLOWING LINE TO BE ABLE TO EXCTRACT OUT</span></span>
<span id="cb4-25"><a href="data-wrangling.html#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="do">## THE DATE BASED ON YOUR NAMING CONVENTION</span></span>
<span id="cb4-26"><a href="data-wrangling.html#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">basedate =</span>  <span class="fu">basename</span>(mat_files) <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(<span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">12</span>)</span>
<span id="cb4-27"><a href="data-wrangling.html#cb4-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-28"><a href="data-wrangling.html#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="data-wrangling.html#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="do">## Matchmake between .MAT data and .CSV log files</span></span>
<span id="cb4-30"><a href="data-wrangling.html#cb4-30" aria-hidden="true" tabindex="-1"></a>csv_mat_filejoin <span class="ot">&lt;-</span></span>
<span id="cb4-31"><a href="data-wrangling.html#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(csv_file_info, mat_file_info, <span class="at">by =</span> <span class="st">&quot;basename&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-32"><a href="data-wrangling.html#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">## OPTIONAL STEP: remove any rows where either the .MAT or .CSV is missing</span></span>
<span id="cb4-33"><a href="data-wrangling.html#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb4-34"><a href="data-wrangling.html#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="data-wrangling.html#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="do">## Store a vector of basenames in the environment. This will become useful later</span></span>
<span id="cb4-36"><a href="data-wrangling.html#cb4-36" aria-hidden="true" tabindex="-1"></a>base_names <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename</span>
<span id="cb4-37"><a href="data-wrangling.html#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="data-wrangling.html#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Your end products from this code block should look something like:</span></span>
<span id="cb4-39"><a href="data-wrangling.html#cb4-39" aria-hidden="true" tabindex="-1"></a>csv_mat_filejoin</span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   csv_files                 basename       basedate.x   mat_files        based…¹
##   &lt;chr&gt;                     &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;            &lt;chr&gt;  
## 1 ./data/2023-02-16_001.csv 2023-02-16_001 2023-02-16_0 ./data/2023-02-… 2023-0…
## # … with abbreviated variable name ¹​basedate.y</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="data-wrangling.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## and:</span></span>
<span id="cb6-2"><a href="data-wrangling.html#cb6-2" aria-hidden="true" tabindex="-1"></a>base_names</span></code></pre></div>
<pre><code>## [1] &quot;2023-02-16_001&quot;</code></pre>
</div>
<div id="data-import-and-preliminary-labeling" class="section level3 hasAnchor" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Data import and preliminary labeling<a href="data-wrangling.html#data-import-and-preliminary-labeling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will now use the <code>R.matlab</code> package to import the <code>.mat</code> file into
R and then label the spike and photodiode time series based on the
information in the <code>.csv</code> log file</p>
<p>Because <code>.mat</code> files can be large, data import can take several
minutes.</p>
<p>Please see in-line comments for further guidance</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="data-wrangling.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set up empty vectors that will collect sets of replicates that we will be</span></span>
<span id="cb8-2"><a href="data-wrangling.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="do">## splitting up</span></span>
<span id="cb8-3"><a href="data-wrangling.html#cb8-3" aria-hidden="true" tabindex="-1"></a>metadata_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-4"><a href="data-wrangling.html#cb8-4" aria-hidden="true" tabindex="-1"></a>meta_splits <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-5"><a href="data-wrangling.html#cb8-5" aria-hidden="true" tabindex="-1"></a>data_splits <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-6"><a href="data-wrangling.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##           used  (Mb) gc trigger  (Mb) limit (Mb) max used  (Mb)
## Ncells 2418164 129.2    3962095 211.6         NA  3962095 211.6
## Vcells 4234452  32.4   10146329  77.5      16384  7316276  55.9</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="data-wrangling.html#cb10-1" aria-hidden="true" tabindex="-1"></a>starttime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>() <span class="do">## Optional, will help you assess run time</span></span>
<span id="cb10-2"><a href="data-wrangling.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(csv_mat_filejoin)) {</span>
<span id="cb10-3"><a href="data-wrangling.html#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="data-wrangling.html#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Which file # are we working on?</span></span>
<span id="cb10-5"><a href="data-wrangling.html#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb10-6"><a href="data-wrangling.html#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="data-wrangling.html#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Set up temporary objects in which to eventually write data</span></span>
<span id="cb10-8"><a href="data-wrangling.html#cb10-8" aria-hidden="true" tabindex="-1"></a>  csv_data_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-9"><a href="data-wrangling.html#cb10-9" aria-hidden="true" tabindex="-1"></a>  mat_data_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-10"><a href="data-wrangling.html#cb10-10" aria-hidden="true" tabindex="-1"></a>  joined_data_sets <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-11"><a href="data-wrangling.html#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="data-wrangling.html#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Import the matlab file. This may take some time</span></span>
<span id="cb10-13"><a href="data-wrangling.html#cb10-13" aria-hidden="true" tabindex="-1"></a>  mat_import <span class="ot">&lt;-</span></span>
<span id="cb10-14"><a href="data-wrangling.html#cb10-14" aria-hidden="true" tabindex="-1"></a>    R.matlab<span class="sc">::</span><span class="fu">readMat</span>(csv_mat_filejoin[i,<span class="st">&quot;mat_files&quot;</span>])</span>
<span id="cb10-15"><a href="data-wrangling.html#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="data-wrangling.html#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Read in the corresponding csv log file</span></span>
<span id="cb10-17"><a href="data-wrangling.html#cb10-17" aria-hidden="true" tabindex="-1"></a>  csv_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-18"><a href="data-wrangling.html#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(<span class="fu">as.character</span>(csv_mat_filejoin[i,<span class="st">&quot;csv_files&quot;</span>]),</span>
<span id="cb10-19"><a href="data-wrangling.html#cb10-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-20"><a href="data-wrangling.html#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Rename columns for convenience</span></span>
<span id="cb10-21"><a href="data-wrangling.html#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb10-22"><a href="data-wrangling.html#cb10-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">Spatial_Frequency =</span> <span class="st">`</span><span class="at">Spatial Frequency</span><span class="st">`</span>,</span>
<span id="cb10-23"><a href="data-wrangling.html#cb10-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">Temporal_Frequency =</span> <span class="st">`</span><span class="at">Temporal Frequency</span><span class="st">`</span>,</span>
<span id="cb10-24"><a href="data-wrangling.html#cb10-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">Cycles_Per_Pixel =</span> <span class="st">`</span><span class="at">Cycles Per Pixel</span><span class="st">`</span></span>
<span id="cb10-25"><a href="data-wrangling.html#cb10-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-26"><a href="data-wrangling.html#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="data-wrangling.html#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="do">## The log file does not have time = 0, so set up a separate tibble to</span></span>
<span id="cb10-28"><a href="data-wrangling.html#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add this info in later. Some of the metadata will just be filler for now.</span></span>
<span id="cb10-29"><a href="data-wrangling.html#cb10-29" aria-hidden="true" tabindex="-1"></a>  initial <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-30"><a href="data-wrangling.html#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">Trial =</span> <span class="st">&quot;initialization&quot;</span>,</span>
<span id="cb10-31"><a href="data-wrangling.html#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">Spatial_Frequency =</span>  csv_data_sets[[i]]<span class="sc">$</span>Spatial_Frequency[<span class="dv">1</span>],</span>
<span id="cb10-32"><a href="data-wrangling.html#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">Cycles_Per_Pixel  =</span>  csv_data_sets[[i]]<span class="sc">$</span>Cycles_Per_Pixel[<span class="dv">1</span>],</span>
<span id="cb10-33"><a href="data-wrangling.html#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">Temporal_Frequency =</span> csv_data_sets[[i]]<span class="sc">$</span>Temporal_Frequency[<span class="dv">1</span>],</span>
<span id="cb10-34"><a href="data-wrangling.html#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">Direction  =</span> csv_data_sets[[i]]<span class="sc">$</span>Direction[<span class="dv">1</span>],</span>
<span id="cb10-35"><a href="data-wrangling.html#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> <span class="fl">0.000</span></span>
<span id="cb10-36"><a href="data-wrangling.html#cb10-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-37"><a href="data-wrangling.html#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="data-wrangling.html#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find photodiode</span></span>
<span id="cb10-39"><a href="data-wrangling.html#cb10-39" aria-hidden="true" tabindex="-1"></a>  <span class="do">## It is almost always in channel 2, but we should be sure to check before</span></span>
<span id="cb10-40"><a href="data-wrangling.html#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extracting automatically</span></span>
<span id="cb10-41"><a href="data-wrangling.html#cb10-41" aria-hidden="true" tabindex="-1"></a>  photod_default_channel <span class="ot">&lt;-</span></span>
<span id="cb10-42"><a href="data-wrangling.html#cb10-42" aria-hidden="true" tabindex="-1"></a>    mat_import[[stringr<span class="sc">::</span><span class="fu">str_which</span>(<span class="fu">names</span>(mat_import), <span class="st">&quot;Ch2&quot;</span>)[<span class="dv">1</span>]]]</span>
<span id="cb10-43"><a href="data-wrangling.html#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>photod_default_channel[<span class="dv">1</span>][[<span class="dv">1</span>]][<span class="dv">1</span>] <span class="sc">==</span> <span class="st">&quot;waveform&quot;</span>) {</span>
<span id="cb10-44"><a href="data-wrangling.html#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;File &quot;</span>, i,<span class="st">&quot;: Photodiode channel identity uncertain&quot;</span>)</span>
<span id="cb10-45"><a href="data-wrangling.html#cb10-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-46"><a href="data-wrangling.html#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="data-wrangling.html#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find spikes</span></span>
<span id="cb10-48"><a href="data-wrangling.html#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Similarly, spikes are almost always in channel 5, but we should check</span></span>
<span id="cb10-49"><a href="data-wrangling.html#cb10-49" aria-hidden="true" tabindex="-1"></a>  spikes_default_channel <span class="ot">&lt;-</span></span>
<span id="cb10-50"><a href="data-wrangling.html#cb10-50" aria-hidden="true" tabindex="-1"></a>    mat_import[[stringr<span class="sc">::</span><span class="fu">str_which</span>(<span class="fu">names</span>(mat_import), <span class="st">&quot;Ch5&quot;</span>)[<span class="dv">1</span>]]]</span>
<span id="cb10-51"><a href="data-wrangling.html#cb10-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;codes&quot;</span> <span class="sc">%not_in%</span> <span class="fu">attributes</span>(spikes_default_channel)<span class="sc">$</span>dimnames[[<span class="dv">1</span>]]) {</span>
<span id="cb10-52"><a href="data-wrangling.html#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;File &quot;</span>, i,<span class="st">&quot;: Sorted spikes channel identity uncertain&quot;</span>)</span>
<span id="cb10-53"><a href="data-wrangling.html#cb10-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-54"><a href="data-wrangling.html#cb10-54" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If that worked, see if we can automatically determine the &quot;times&quot; and</span></span>
<span id="cb10-55"><a href="data-wrangling.html#cb10-55" aria-hidden="true" tabindex="-1"></a>  <span class="do">## &quot;codes&quot; slot numbers</span></span>
<span id="cb10-56"><a href="data-wrangling.html#cb10-56" aria-hidden="true" tabindex="-1"></a>  times_location <span class="ot">&lt;-</span></span>
<span id="cb10-57"><a href="data-wrangling.html#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(<span class="fu">attributes</span>(spikes_default_channel)<span class="sc">$</span>dimnames[[<span class="dv">1</span>]] <span class="sc">==</span> <span class="st">&quot;times&quot;</span>)</span>
<span id="cb10-58"><a href="data-wrangling.html#cb10-58" aria-hidden="true" tabindex="-1"></a>  codes_location <span class="ot">&lt;-</span></span>
<span id="cb10-59"><a href="data-wrangling.html#cb10-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(<span class="fu">attributes</span>(spikes_default_channel)<span class="sc">$</span>dimnames[[<span class="dv">1</span>]] <span class="sc">==</span> <span class="st">&quot;codes&quot;</span>)</span>
<span id="cb10-60"><a href="data-wrangling.html#cb10-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-61"><a href="data-wrangling.html#cb10-61" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find matlab&#39;s stimulus change log</span></span>
<span id="cb10-62"><a href="data-wrangling.html#cb10-62" aria-hidden="true" tabindex="-1"></a>  stim_change_channel <span class="ot">&lt;-</span></span>
<span id="cb10-63"><a href="data-wrangling.html#cb10-63" aria-hidden="true" tabindex="-1"></a>    mat_import[[stringr<span class="sc">::</span><span class="fu">str_which</span>(<span class="fu">names</span>(mat_import), <span class="st">&quot;Ch3&quot;</span>)[<span class="dv">1</span>]]]</span>
<span id="cb10-64"><a href="data-wrangling.html#cb10-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Each sweep should be 5 secs. We&#39;ll check that the median is 5</span></span>
<span id="cb10-65"><a href="data-wrangling.html#cb10-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If this results in an error, then the channel identity could be wrong, or</span></span>
<span id="cb10-66"><a href="data-wrangling.html#cb10-66" aria-hidden="true" tabindex="-1"></a>  <span class="do">## there may have been an issue with sweep duration during the recording</span></span>
<span id="cb10-67"><a href="data-wrangling.html#cb10-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## process</span></span>
<span id="cb10-68"><a href="data-wrangling.html#cb10-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">median</span>(<span class="fu">round</span>(<span class="fu">diff</span>(stim_change_channel[[<span class="dv">5</span>]][,<span class="dv">1</span>]),<span class="dv">0</span>)) <span class="sc">==</span> <span class="dv">5</span>) {</span>
<span id="cb10-69"><a href="data-wrangling.html#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;File &quot;</span>, i,<span class="st">&quot;: stim change channel identity uncertain&quot;</span>)</span>
<span id="cb10-70"><a href="data-wrangling.html#cb10-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-71"><a href="data-wrangling.html#cb10-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-72"><a href="data-wrangling.html#cb10-72" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Determine when the onset of motion occurred according to matlab</span></span>
<span id="cb10-73"><a href="data-wrangling.html#cb10-73" aria-hidden="true" tabindex="-1"></a>  first_moving_mat <span class="ot">&lt;-</span></span>
<span id="cb10-74"><a href="data-wrangling.html#cb10-74" aria-hidden="true" tabindex="-1"></a>    stim_change_channel[[<span class="dv">5</span>]][,<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb10-75"><a href="data-wrangling.html#cb10-75" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find the first &quot;moving&quot; phase in the log file</span></span>
<span id="cb10-76"><a href="data-wrangling.html#cb10-76" aria-hidden="true" tabindex="-1"></a>  first_moving_csv <span class="ot">&lt;-</span></span>
<span id="cb10-77"><a href="data-wrangling.html#cb10-77" aria-hidden="true" tabindex="-1"></a>    csv_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb10-78"><a href="data-wrangling.html#cb10-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Trial <span class="sc">==</span> <span class="st">&quot;moving&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-79"><a href="data-wrangling.html#cb10-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb10-80"><a href="data-wrangling.html#cb10-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-81"><a href="data-wrangling.html#cb10-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb10-82"><a href="data-wrangling.html#cb10-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find the first &quot;blank&quot; phase in the log file</span></span>
<span id="cb10-83"><a href="data-wrangling.html#cb10-83" aria-hidden="true" tabindex="-1"></a>  first_blank <span class="ot">&lt;-</span></span>
<span id="cb10-84"><a href="data-wrangling.html#cb10-84" aria-hidden="true" tabindex="-1"></a>    csv_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb10-85"><a href="data-wrangling.html#cb10-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Trial <span class="sc">==</span> <span class="st">&quot;blank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-86"><a href="data-wrangling.html#cb10-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb10-87"><a href="data-wrangling.html#cb10-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-88"><a href="data-wrangling.html#cb10-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb10-89"><a href="data-wrangling.html#cb10-89" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Compute the difference between these two</span></span>
<span id="cb10-90"><a href="data-wrangling.html#cb10-90" aria-hidden="true" tabindex="-1"></a>  first_mvbl_diff <span class="ot">&lt;-</span> first_moving_csv <span class="sc">-</span> first_blank</span>
<span id="cb10-91"><a href="data-wrangling.html#cb10-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-92"><a href="data-wrangling.html#cb10-92" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Check to see if the final row of the metadata is &quot;moving&quot; and truncate</span></span>
<span id="cb10-93"><a href="data-wrangling.html#cb10-93" aria-hidden="true" tabindex="-1"></a>  <span class="do">## if not</span></span>
<span id="cb10-94"><a href="data-wrangling.html#cb10-94" aria-hidden="true" tabindex="-1"></a>  <span class="do">## This can effectively be done by truncating after the final &quot;moving&quot; phase</span></span>
<span id="cb10-95"><a href="data-wrangling.html#cb10-95" aria-hidden="true" tabindex="-1"></a>  max_moving_sweep <span class="ot">&lt;-</span></span>
<span id="cb10-96"><a href="data-wrangling.html#cb10-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(<span class="fu">which</span>(csv_data_sets[[i]]<span class="sc">$</span>Trial <span class="sc">==</span> <span class="st">&quot;moving&quot;</span>))</span>
<span id="cb10-97"><a href="data-wrangling.html#cb10-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-98"><a href="data-wrangling.html#cb10-98" aria-hidden="true" tabindex="-1"></a>  first_csv_tmp <span class="ot">&lt;-</span></span>
<span id="cb10-99"><a href="data-wrangling.html#cb10-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(initial, csv_data_sets[[i]]) <span class="sc">%&gt;%</span></span>
<span id="cb10-100"><a href="data-wrangling.html#cb10-100" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Add 1 to max moving sweep since we tacked on &quot;initial&quot; in previous step</span></span>
<span id="cb10-101"><a href="data-wrangling.html#cb10-101" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Then slice to restrict any extraneous partial sweeps</span></span>
<span id="cb10-102"><a href="data-wrangling.html#cb10-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_head</span>(<span class="at">n =</span> (max_moving_sweep <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-103"><a href="data-wrangling.html#cb10-103" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Add the first event time to &quot;Time&quot; and subtract first_mvbl_diff (~2 secs)</span></span>
<span id="cb10-104"><a href="data-wrangling.html#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="do">## What this does is shift the log csv&#39;s time stamping to match the matlab</span></span>
<span id="cb10-105"><a href="data-wrangling.html#cb10-105" aria-hidden="true" tabindex="-1"></a>    <span class="do">## file&#39;s stim change channel&#39;s time stamping</span></span>
<span id="cb10-106"><a href="data-wrangling.html#cb10-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time =</span> Time <span class="sc">+</span> first_moving_mat <span class="sc">-</span> first_mvbl_diff <span class="sc">-</span> first_blank) <span class="sc">%&gt;%</span></span>
<span id="cb10-107"><a href="data-wrangling.html#cb10-107" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Make character version of Time for joining later</span></span>
<span id="cb10-108"><a href="data-wrangling.html#cb10-108" aria-hidden="true" tabindex="-1"></a>    <span class="do">## This will be crucial for _join functions</span></span>
<span id="cb10-109"><a href="data-wrangling.html#cb10-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time,<span class="dv">3</span>)))</span>
<span id="cb10-110"><a href="data-wrangling.html#cb10-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-111"><a href="data-wrangling.html#cb10-111" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Duplicate the initialization for ease of setting T0</span></span>
<span id="cb10-112"><a href="data-wrangling.html#cb10-112" aria-hidden="true" tabindex="-1"></a>  inception <span class="ot">&lt;-</span></span>
<span id="cb10-113"><a href="data-wrangling.html#cb10-113" aria-hidden="true" tabindex="-1"></a>    initial <span class="sc">%&gt;%</span></span>
<span id="cb10-114"><a href="data-wrangling.html#cb10-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time,<span class="dv">3</span>)))</span>
<span id="cb10-115"><a href="data-wrangling.html#cb10-115" aria-hidden="true" tabindex="-1"></a>  inception<span class="sc">$</span>Trial[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;inception&quot;</span></span>
<span id="cb10-116"><a href="data-wrangling.html#cb10-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-117"><a href="data-wrangling.html#cb10-117" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Bind the initialization rows</span></span>
<span id="cb10-118"><a href="data-wrangling.html#cb10-118" aria-hidden="true" tabindex="-1"></a>  first_csv <span class="ot">&lt;-</span></span>
<span id="cb10-119"><a href="data-wrangling.html#cb10-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(inception, first_csv_tmp)</span>
<span id="cb10-120"><a href="data-wrangling.html#cb10-120" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Compute stimulus end times</span></span>
<span id="cb10-121"><a href="data-wrangling.html#cb10-121" aria-hidden="true" tabindex="-1"></a>  first_csv<span class="sc">$</span>Stim_end <span class="ot">&lt;-</span> <span class="fu">c</span>(first_csv<span class="sc">$</span>Time[<span class="sc">-</span><span class="dv">1</span>], <span class="fu">max</span>(first_csv<span class="sc">$</span>Time) <span class="sc">+</span> <span class="dv">3</span>)</span>
<span id="cb10-122"><a href="data-wrangling.html#cb10-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-123"><a href="data-wrangling.html#cb10-123" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Get final time</span></span>
<span id="cb10-124"><a href="data-wrangling.html#cb10-124" aria-hidden="true" tabindex="-1"></a>  final_time <span class="ot">&lt;-</span> first_csv<span class="sc">$</span>Stim_end[<span class="fu">nrow</span>(first_csv)]</span>
<span id="cb10-125"><a href="data-wrangling.html#cb10-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-126"><a href="data-wrangling.html#cb10-126" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extract photodiode data</span></span>
<span id="cb10-127"><a href="data-wrangling.html#cb10-127" aria-hidden="true" tabindex="-1"></a>  <span class="do">## First generate a time sequence to match to the photodiode trace</span></span>
<span id="cb10-128"><a href="data-wrangling.html#cb10-128" aria-hidden="true" tabindex="-1"></a>  Time_vec <span class="ot">&lt;-</span> <span class="fu">seq</span>(</span>
<span id="cb10-129"><a href="data-wrangling.html#cb10-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> <span class="fl">0.0000</span>,</span>
<span id="cb10-130"><a href="data-wrangling.html#cb10-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">25000</span>,</span>
<span id="cb10-131"><a href="data-wrangling.html#cb10-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">length.out =</span> <span class="fu">length</span>(photod_default_channel[<span class="dv">9</span>][[<span class="dv">1</span>]][, <span class="dv">1</span>])</span>
<span id="cb10-132"><a href="data-wrangling.html#cb10-132" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-133"><a href="data-wrangling.html#cb10-133" aria-hidden="true" tabindex="-1"></a>  <span class="do">## The key thing is to get a character version of time from this</span></span>
<span id="cb10-134"><a href="data-wrangling.html#cb10-134" aria-hidden="true" tabindex="-1"></a>  Time_char_vec <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time_vec, <span class="dv">3</span>))</span>
<span id="cb10-135"><a href="data-wrangling.html#cb10-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-136"><a href="data-wrangling.html#cb10-136" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Grab the photodiode data</span></span>
<span id="cb10-137"><a href="data-wrangling.html#cb10-137" aria-hidden="true" tabindex="-1"></a>  photod_full <span class="ot">&lt;-</span></span>
<span id="cb10-138"><a href="data-wrangling.html#cb10-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">Photod =</span></span>
<span id="cb10-139"><a href="data-wrangling.html#cb10-139" aria-hidden="true" tabindex="-1"></a>             photod_default_channel[<span class="dv">9</span>][[<span class="dv">1</span>]][, <span class="dv">1</span>])</span>
<span id="cb10-140"><a href="data-wrangling.html#cb10-140" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Add numeric time</span></span>
<span id="cb10-141"><a href="data-wrangling.html#cb10-141" aria-hidden="true" tabindex="-1"></a>  photod_full<span class="sc">$</span>Time <span class="ot">&lt;-</span></span>
<span id="cb10-142"><a href="data-wrangling.html#cb10-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(</span>
<span id="cb10-143"><a href="data-wrangling.html#cb10-143" aria-hidden="true" tabindex="-1"></a>      <span class="at">from =</span> <span class="fl">0.0000</span>,</span>
<span id="cb10-144"><a href="data-wrangling.html#cb10-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">25000</span>,</span>
<span id="cb10-145"><a href="data-wrangling.html#cb10-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">length.out =</span> <span class="fu">nrow</span>(photod_full)</span>
<span id="cb10-146"><a href="data-wrangling.html#cb10-146" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-147"><a href="data-wrangling.html#cb10-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb10-148"><a href="data-wrangling.html#cb10-148" aria-hidden="true" tabindex="-1"></a>  photod_full <span class="ot">&lt;-</span></span>
<span id="cb10-149"><a href="data-wrangling.html#cb10-149" aria-hidden="true" tabindex="-1"></a>    photod_full <span class="sc">%&gt;%</span></span>
<span id="cb10-150"><a href="data-wrangling.html#cb10-150" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Add the character time</span></span>
<span id="cb10-151"><a href="data-wrangling.html#cb10-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_column</span>(<span class="at">Time_char =</span> Time_char_vec) <span class="sc">%&gt;%</span></span>
<span id="cb10-152"><a href="data-wrangling.html#cb10-152" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Use the charcter time to define a group</span></span>
<span id="cb10-153"><a href="data-wrangling.html#cb10-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Time_char) <span class="sc">%&gt;%</span></span>
<span id="cb10-154"><a href="data-wrangling.html#cb10-154" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Then average the photodiode within</span></span>
<span id="cb10-155"><a href="data-wrangling.html#cb10-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Photod =</span> <span class="fu">mean</span>(Photod)) <span class="sc">%&gt;%</span></span>
<span id="cb10-156"><a href="data-wrangling.html#cb10-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-157"><a href="data-wrangling.html#cb10-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(Time_char), <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-158"><a href="data-wrangling.html#cb10-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb10-159"><a href="data-wrangling.html#cb10-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> final_time)</span>
<span id="cb10-160"><a href="data-wrangling.html#cb10-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-161"><a href="data-wrangling.html#cb10-161" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extract all spike data</span></span>
<span id="cb10-162"><a href="data-wrangling.html#cb10-162" aria-hidden="true" tabindex="-1"></a>  all_spike_dat <span class="ot">&lt;-</span></span>
<span id="cb10-163"><a href="data-wrangling.html#cb10-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb10-164"><a href="data-wrangling.html#cb10-164" aria-hidden="true" tabindex="-1"></a>      <span class="at">Time =</span></span>
<span id="cb10-165"><a href="data-wrangling.html#cb10-165" aria-hidden="true" tabindex="-1"></a>        spikes_default_channel[times_location][[<span class="dv">1</span>]][, <span class="dv">1</span>],</span>
<span id="cb10-166"><a href="data-wrangling.html#cb10-166" aria-hidden="true" tabindex="-1"></a>      <span class="at">code =</span></span>
<span id="cb10-167"><a href="data-wrangling.html#cb10-167" aria-hidden="true" tabindex="-1"></a>        spikes_default_channel[codes_location][[<span class="dv">1</span>]][, <span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb10-168"><a href="data-wrangling.html#cb10-168" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Characterize time, for purposes of joining later</span></span>
<span id="cb10-169"><a href="data-wrangling.html#cb10-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time, <span class="dv">3</span>)))</span>
<span id="cb10-170"><a href="data-wrangling.html#cb10-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-171"><a href="data-wrangling.html#cb10-171" aria-hidden="true" tabindex="-1"></a>  <span class="do">## How many distinct neurons are there?</span></span>
<span id="cb10-172"><a href="data-wrangling.html#cb10-172" aria-hidden="true" tabindex="-1"></a>  cell_ids <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(all_spike_dat<span class="sc">$</span>code))</span>
<span id="cb10-173"><a href="data-wrangling.html#cb10-173" aria-hidden="true" tabindex="-1"></a>  n_cells <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cell_ids)</span>
<span id="cb10-174"><a href="data-wrangling.html#cb10-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-175"><a href="data-wrangling.html#cb10-175" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(n_cells) <span class="sc">&gt;</span> <span class="dv">1</span>) { <span class="do">## if there&#39;s more than one distinct neuron</span></span>
<span id="cb10-176"><a href="data-wrangling.html#cb10-176" aria-hidden="true" tabindex="-1"></a>    all_spike_dat_tmp <span class="ot">&lt;-</span></span>
<span id="cb10-177"><a href="data-wrangling.html#cb10-177" aria-hidden="true" tabindex="-1"></a>      all_spike_dat <span class="sc">%&gt;%</span></span>
<span id="cb10-178"><a href="data-wrangling.html#cb10-178" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Group by identity of spiking neuron</span></span>
<span id="cb10-179"><a href="data-wrangling.html#cb10-179" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(code) <span class="sc">%&gt;%</span></span>
<span id="cb10-180"><a href="data-wrangling.html#cb10-180" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Split into separate dfs, one per neuron</span></span>
<span id="cb10-181"><a href="data-wrangling.html#cb10-181" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_split</span>()</span>
<span id="cb10-182"><a href="data-wrangling.html#cb10-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-183"><a href="data-wrangling.html#cb10-183" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Additional cells are labeled as &quot;Spike_n&quot;</span></span>
<span id="cb10-184"><a href="data-wrangling.html#cb10-184" aria-hidden="true" tabindex="-1"></a>    all_cells <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-185"><a href="data-wrangling.html#cb10-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> n_cells) {</span>
<span id="cb10-186"><a href="data-wrangling.html#cb10-186" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(j)</span></span>
<span id="cb10-187"><a href="data-wrangling.html#cb10-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-188"><a href="data-wrangling.html#cb10-188" aria-hidden="true" tabindex="-1"></a>      new_name <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;Spikes_&quot;</span>, cell_ids[j])</span>
<span id="cb10-189"><a href="data-wrangling.html#cb10-189" aria-hidden="true" tabindex="-1"></a>      all_cells[[j]] <span class="ot">&lt;-</span></span>
<span id="cb10-190"><a href="data-wrangling.html#cb10-190" aria-hidden="true" tabindex="-1"></a>        all_spike_dat_tmp[[j]]</span>
<span id="cb10-191"><a href="data-wrangling.html#cb10-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-192"><a href="data-wrangling.html#cb10-192" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Consolidate to 3 decimal places</span></span>
<span id="cb10-193"><a href="data-wrangling.html#cb10-193" aria-hidden="true" tabindex="-1"></a>      all_cells[[j]] <span class="ot">&lt;-</span></span>
<span id="cb10-194"><a href="data-wrangling.html#cb10-194" aria-hidden="true" tabindex="-1"></a>        all_cells[[j]] <span class="sc">%&gt;%</span></span>
<span id="cb10-195"><a href="data-wrangling.html#cb10-195" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(Time_char) <span class="sc">%&gt;%</span></span>
<span id="cb10-196"><a href="data-wrangling.html#cb10-196" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">code =</span> <span class="fu">mean</span>(code)) <span class="sc">%&gt;%</span></span>
<span id="cb10-197"><a href="data-wrangling.html#cb10-197" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">code =</span> <span class="fu">ceiling</span>(code)) <span class="sc">%&gt;%</span></span>
<span id="cb10-198"><a href="data-wrangling.html#cb10-198" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-199"><a href="data-wrangling.html#cb10-199" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Time =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(Time_char), <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-200"><a href="data-wrangling.html#cb10-200" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb10-201"><a href="data-wrangling.html#cb10-201" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> final_time)</span>
<span id="cb10-202"><a href="data-wrangling.html#cb10-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-203"><a href="data-wrangling.html#cb10-203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(all_cells[[j]])[<span class="fu">match</span>(<span class="st">&quot;code&quot;</span>, <span class="fu">names</span>(all_cells[[j]]))] <span class="ot">&lt;-</span></span>
<span id="cb10-204"><a href="data-wrangling.html#cb10-204" aria-hidden="true" tabindex="-1"></a>        new_name</span>
<span id="cb10-205"><a href="data-wrangling.html#cb10-205" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Replace &quot;j&quot; with 1 to indicate presence/absence of spike rather than</span></span>
<span id="cb10-206"><a href="data-wrangling.html#cb10-206" aria-hidden="true" tabindex="-1"></a>      <span class="do">## cell identity</span></span>
<span id="cb10-207"><a href="data-wrangling.html#cb10-207" aria-hidden="true" tabindex="-1"></a>      all_cells[[j]][new_name] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-208"><a href="data-wrangling.html#cb10-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-209"><a href="data-wrangling.html#cb10-209" aria-hidden="true" tabindex="-1"></a>      <span class="do">## If the identity is 1, replace &quot;Spikes_1&quot; with just &quot;Spikes&quot;</span></span>
<span id="cb10-210"><a href="data-wrangling.html#cb10-210" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (new_name <span class="sc">==</span> <span class="st">&quot;Spikes_1&quot;</span>) {</span>
<span id="cb10-211"><a href="data-wrangling.html#cb10-211" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(all_cells[[j]])[<span class="fu">match</span>(new_name, <span class="fu">names</span>(all_cells[[j]]))] <span class="ot">&lt;-</span></span>
<span id="cb10-212"><a href="data-wrangling.html#cb10-212" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;Spikes&quot;</span></span>
<span id="cb10-213"><a href="data-wrangling.html#cb10-213" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-214"><a href="data-wrangling.html#cb10-214" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-215"><a href="data-wrangling.html#cb10-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-216"><a href="data-wrangling.html#cb10-216" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Consolidate</span></span>
<span id="cb10-217"><a href="data-wrangling.html#cb10-217" aria-hidden="true" tabindex="-1"></a>    all_spike_dat <span class="ot">&lt;-</span></span>
<span id="cb10-218"><a href="data-wrangling.html#cb10-218" aria-hidden="true" tabindex="-1"></a>      all_cells <span class="sc">%&gt;%</span></span>
<span id="cb10-219"><a href="data-wrangling.html#cb10-219" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Tack on additional spike columns</span></span>
<span id="cb10-220"><a href="data-wrangling.html#cb10-220" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reduce</span>(full_join, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-221"><a href="data-wrangling.html#cb10-221" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(Time_char) <span class="sc">%&gt;%</span></span>
<span id="cb10-222"><a href="data-wrangling.html#cb10-222" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Remove time.n columns but</span></span>
<span id="cb10-223"><a href="data-wrangling.html#cb10-223" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Do not remove Time_char</span></span>
<span id="cb10-224"><a href="data-wrangling.html#cb10-224" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">&quot;Time.&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-225"><a href="data-wrangling.html#cb10-225" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Regenerate numeric time</span></span>
<span id="cb10-226"><a href="data-wrangling.html#cb10-226" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-227"><a href="data-wrangling.html#cb10-227" aria-hidden="true" tabindex="-1"></a>        <span class="at">Time =</span> <span class="fu">as.numeric</span>(Time_char)</span>
<span id="cb10-228"><a href="data-wrangling.html#cb10-228" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb10-229"><a href="data-wrangling.html#cb10-229" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(Time, Time_char, Spikes, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb10-230"><a href="data-wrangling.html#cb10-230" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> final_time)</span>
<span id="cb10-231"><a href="data-wrangling.html#cb10-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-232"><a href="data-wrangling.html#cb10-232" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="do">## If there&#39;s only 1 neuron</span></span>
<span id="cb10-233"><a href="data-wrangling.html#cb10-233" aria-hidden="true" tabindex="-1"></a>    all_spike_dat <span class="ot">&lt;-</span></span>
<span id="cb10-234"><a href="data-wrangling.html#cb10-234" aria-hidden="true" tabindex="-1"></a>      all_spike_dat <span class="sc">%&gt;%</span></span>
<span id="cb10-235"><a href="data-wrangling.html#cb10-235" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Time_char) <span class="sc">%&gt;%</span></span>
<span id="cb10-236"><a href="data-wrangling.html#cb10-236" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">code =</span> <span class="fu">mean</span>(code)) <span class="sc">%&gt;%</span></span>
<span id="cb10-237"><a href="data-wrangling.html#cb10-237" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">code =</span> <span class="fu">ceiling</span>(code)) <span class="sc">%&gt;%</span></span>
<span id="cb10-238"><a href="data-wrangling.html#cb10-238" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-239"><a href="data-wrangling.html#cb10-239" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">Spikes =</span> code) <span class="sc">%&gt;%</span></span>
<span id="cb10-240"><a href="data-wrangling.html#cb10-240" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Time =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(Time_char), <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-241"><a href="data-wrangling.html#cb10-241" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb10-242"><a href="data-wrangling.html#cb10-242" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> final_time) <span class="sc">%&gt;%</span></span>
<span id="cb10-243"><a href="data-wrangling.html#cb10-243" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(Time, Time_char, <span class="fu">everything</span>())</span>
<span id="cb10-244"><a href="data-wrangling.html#cb10-244" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-245"><a href="data-wrangling.html#cb10-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-246"><a href="data-wrangling.html#cb10-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span>
<span id="cb10-247"><a href="data-wrangling.html#cb10-247" aria-hidden="true" tabindex="-1"></a>  mat_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-248"><a href="data-wrangling.html#cb10-248" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Generate a time sequence from 0 to final_time</span></span>
<span id="cb10-249"><a href="data-wrangling.html#cb10-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb10-250"><a href="data-wrangling.html#cb10-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">Time =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> final_time, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb10-251"><a href="data-wrangling.html#cb10-251" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb10-252"><a href="data-wrangling.html#cb10-252" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Character-ize it</span></span>
<span id="cb10-253"><a href="data-wrangling.html#cb10-253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time_char =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(Time, <span class="dv">5</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb10-254"><a href="data-wrangling.html#cb10-254" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Join in the photodiode data</span></span>
<span id="cb10-255"><a href="data-wrangling.html#cb10-255" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(photod_full, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-256"><a href="data-wrangling.html#cb10-256" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Time.y) <span class="sc">%&gt;%</span></span>
<span id="cb10-257"><a href="data-wrangling.html#cb10-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Time =</span> Time.x) <span class="sc">%&gt;%</span></span>
<span id="cb10-258"><a href="data-wrangling.html#cb10-258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb10-259"><a href="data-wrangling.html#cb10-259" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Join in the spike data</span></span>
<span id="cb10-260"><a href="data-wrangling.html#cb10-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(all_spike_dat, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-261"><a href="data-wrangling.html#cb10-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Time.y) <span class="sc">%&gt;%</span></span>
<span id="cb10-262"><a href="data-wrangling.html#cb10-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Time =</span> Time.x) <span class="sc">%&gt;%</span></span>
<span id="cb10-263"><a href="data-wrangling.html#cb10-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Time) <span class="sc">%&gt;%</span></span>
<span id="cb10-264"><a href="data-wrangling.html#cb10-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> final_time) <span class="sc">%&gt;%</span></span>
<span id="cb10-265"><a href="data-wrangling.html#cb10-265" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Replace NAs with 0 in the Spike columns only</span></span>
<span id="cb10-266"><a href="data-wrangling.html#cb10-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-267"><a href="data-wrangling.html#cb10-267" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;Spikes&quot;</span>), <span class="sc">~</span><span class="fu">replace_na</span>(.x, <span class="dv">0</span>))</span>
<span id="cb10-268"><a href="data-wrangling.html#cb10-268" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-269"><a href="data-wrangling.html#cb10-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-270"><a href="data-wrangling.html#cb10-270" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Merge the matlab data with the metadata</span></span>
<span id="cb10-271"><a href="data-wrangling.html#cb10-271" aria-hidden="true" tabindex="-1"></a>  joined_one_full <span class="ot">&lt;-</span></span>
<span id="cb10-272"><a href="data-wrangling.html#cb10-272" aria-hidden="true" tabindex="-1"></a>    mat_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb10-273"><a href="data-wrangling.html#cb10-273" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Join by the character version of time NOT the numerical!!</span></span>
<span id="cb10-274"><a href="data-wrangling.html#cb10-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">full_join</span>(first_csv, <span class="at">by =</span> <span class="st">&quot;Time_char&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-275"><a href="data-wrangling.html#cb10-275" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Rename columns for clarity of reference</span></span>
<span id="cb10-276"><a href="data-wrangling.html#cb10-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Time_mat =</span> Time.x,</span>
<span id="cb10-277"><a href="data-wrangling.html#cb10-277" aria-hidden="true" tabindex="-1"></a>           <span class="at">Time_csv =</span> Time.y) <span class="sc">%&gt;%</span></span>
<span id="cb10-278"><a href="data-wrangling.html#cb10-278" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Convert character time to numeric time</span></span>
<span id="cb10-279"><a href="data-wrangling.html#cb10-279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Time =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(Time_char), <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-280"><a href="data-wrangling.html#cb10-280" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Carry metadata forward</span></span>
<span id="cb10-281"><a href="data-wrangling.html#cb10-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-282"><a href="data-wrangling.html#cb10-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">Trial =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Trial, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb10-283"><a href="data-wrangling.html#cb10-283" aria-hidden="true" tabindex="-1"></a>      <span class="at">Spatial_Frequency =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Spatial_Frequency, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb10-284"><a href="data-wrangling.html#cb10-284" aria-hidden="true" tabindex="-1"></a>      <span class="at">Cycles_Per_Pixel  =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Cycles_Per_Pixel, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb10-285"><a href="data-wrangling.html#cb10-285" aria-hidden="true" tabindex="-1"></a>      <span class="at">Temporal_Frequency =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Temporal_Frequency, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb10-286"><a href="data-wrangling.html#cb10-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">Direction =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Direction, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb10-287"><a href="data-wrangling.html#cb10-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">Time_csv =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Time_csv, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>),</span>
<span id="cb10-288"><a href="data-wrangling.html#cb10-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">Stim_end =</span> zoo<span class="sc">::</span><span class="fu">na.locf</span>(Stim_end, <span class="at">type =</span> <span class="st">&quot;locf&quot;</span>)</span>
<span id="cb10-289"><a href="data-wrangling.html#cb10-289" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb10-290"><a href="data-wrangling.html#cb10-290" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Calculate velocity</span></span>
<span id="cb10-291"><a href="data-wrangling.html#cb10-291" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-292"><a href="data-wrangling.html#cb10-292" aria-hidden="true" tabindex="-1"></a>      <span class="at">Speed =</span> <span class="fu">round</span>(Temporal_Frequency<span class="sc">/</span>Spatial_Frequency, <span class="dv">0</span>),</span>
<span id="cb10-293"><a href="data-wrangling.html#cb10-293" aria-hidden="true" tabindex="-1"></a>      <span class="at">Log2_Speed =</span> <span class="fu">log2</span>(Speed)</span>
<span id="cb10-294"><a href="data-wrangling.html#cb10-294" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-295"><a href="data-wrangling.html#cb10-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-296"><a href="data-wrangling.html#cb10-296" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Add info to metadata</span></span>
<span id="cb10-297"><a href="data-wrangling.html#cb10-297" aria-hidden="true" tabindex="-1"></a>  metadata_one_full <span class="ot">&lt;-</span></span>
<span id="cb10-298"><a href="data-wrangling.html#cb10-298" aria-hidden="true" tabindex="-1"></a>    first_csv <span class="sc">%&gt;%</span></span>
<span id="cb10-299"><a href="data-wrangling.html#cb10-299" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-300"><a href="data-wrangling.html#cb10-300" aria-hidden="true" tabindex="-1"></a>      <span class="at">Speed =</span> <span class="fu">round</span>(Temporal_Frequency<span class="sc">/</span>Spatial_Frequency, <span class="dv">0</span>),</span>
<span id="cb10-301"><a href="data-wrangling.html#cb10-301" aria-hidden="true" tabindex="-1"></a>      <span class="at">Log2_Speed =</span> <span class="fu">log2</span>(Speed),</span>
<span id="cb10-302"><a href="data-wrangling.html#cb10-302" aria-hidden="true" tabindex="-1"></a>      <span class="at">Stim_end_diff =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(Stim_end))</span>
<span id="cb10-303"><a href="data-wrangling.html#cb10-303" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-304"><a href="data-wrangling.html#cb10-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-305"><a href="data-wrangling.html#cb10-305" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Some quality control checks</span></span>
<span id="cb10-306"><a href="data-wrangling.html#cb10-306" aria-hidden="true" tabindex="-1"></a>  <span class="do">## What are the stim time differences?</span></span>
<span id="cb10-307"><a href="data-wrangling.html#cb10-307" aria-hidden="true" tabindex="-1"></a>  stimtime_diffs <span class="ot">&lt;-</span> <span class="fu">round</span>(metadata_one_full<span class="sc">$</span>Stim_end_diff)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span>
<span id="cb10-308"><a href="data-wrangling.html#cb10-308" aria-hidden="true" tabindex="-1"></a>  <span class="do">## How many total reps were recorded?</span></span>
<span id="cb10-309"><a href="data-wrangling.html#cb10-309" aria-hidden="true" tabindex="-1"></a>  stimtime_reps <span class="ot">&lt;-</span> <span class="fu">length</span>(stimtime_diffs)<span class="sc">/</span><span class="dv">3</span></span>
<span id="cb10-310"><a href="data-wrangling.html#cb10-310" aria-hidden="true" tabindex="-1"></a>  <span class="do">## What do we expect the overall structure to look like?</span></span>
<span id="cb10-311"><a href="data-wrangling.html#cb10-311" aria-hidden="true" tabindex="-1"></a>  stimtime_expectation <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>), stimtime_reps)</span>
<span id="cb10-312"><a href="data-wrangling.html#cb10-312" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Does reality match our expectations?</span></span>
<span id="cb10-313"><a href="data-wrangling.html#cb10-313" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(stimtime_diffs <span class="sc">==</span> stimtime_expectation)) {</span>
<span id="cb10-314"><a href="data-wrangling.html#cb10-314" aria-hidden="true" tabindex="-1"></a>    <span class="do">## If you get this, investigate the file further and determine what went</span></span>
<span id="cb10-315"><a href="data-wrangling.html#cb10-315" aria-hidden="true" tabindex="-1"></a>    <span class="do">## wrong</span></span>
<span id="cb10-316"><a href="data-wrangling.html#cb10-316" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;stimtime issue; investigate&quot;</span>)</span>
<span id="cb10-317"><a href="data-wrangling.html#cb10-317" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-318"><a href="data-wrangling.html#cb10-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-319"><a href="data-wrangling.html#cb10-319" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Sometimes the final sweep gets carried for an indefinite amount of time</span></span>
<span id="cb10-320"><a href="data-wrangling.html#cb10-320" aria-hidden="true" tabindex="-1"></a>  <span class="do">## before the investigator manually shuts things off. The following block</span></span>
<span id="cb10-321"><a href="data-wrangling.html#cb10-321" aria-hidden="true" tabindex="-1"></a>  <span class="do">## truncates accordingly</span></span>
<span id="cb10-322"><a href="data-wrangling.html#cb10-322" aria-hidden="true" tabindex="-1"></a>  mark_for_removal <span class="ot">&lt;-</span></span>
<span id="cb10-323"><a href="data-wrangling.html#cb10-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">which</span>(<span class="fu">round</span>(metadata_one_full<span class="sc">$</span>Stim_end_diff) <span class="sc">%not_in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb10-324"><a href="data-wrangling.html#cb10-324" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(mark_for_removal <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> mark_for_removal <span class="sc">==</span> <span class="dv">2</span>)) {</span>
<span id="cb10-325"><a href="data-wrangling.html#cb10-325" aria-hidden="true" tabindex="-1"></a>    mark_for_removal <span class="ot">&lt;-</span> mark_for_removal[mark_for_removal <span class="sc">&gt;</span> <span class="dv">2</span>]</span>
<span id="cb10-326"><a href="data-wrangling.html#cb10-326" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-327"><a href="data-wrangling.html#cb10-327" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(mark_for_removal) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-328"><a href="data-wrangling.html#cb10-328" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-329"><a href="data-wrangling.html#cb10-329" aria-hidden="true" tabindex="-1"></a>      metadata_one_full <span class="sc">%&gt;%</span></span>
<span id="cb10-330"><a href="data-wrangling.html#cb10-330" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Time <span class="sc">&lt;</span> metadata_one_full[mark_for_removal[<span class="dv">1</span>],]<span class="sc">$</span>Time)</span>
<span id="cb10-331"><a href="data-wrangling.html#cb10-331" aria-hidden="true" tabindex="-1"></a>    joined_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-332"><a href="data-wrangling.html#cb10-332" aria-hidden="true" tabindex="-1"></a>      joined_one_full <span class="sc">%&gt;%</span></span>
<span id="cb10-333"><a href="data-wrangling.html#cb10-333" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Time_mat <span class="sc">&lt;</span> metadata_one_full[mark_for_removal[<span class="dv">1</span>],]<span class="sc">$</span>Time)</span>
<span id="cb10-334"><a href="data-wrangling.html#cb10-334" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-335"><a href="data-wrangling.html#cb10-335" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-336"><a href="data-wrangling.html#cb10-336" aria-hidden="true" tabindex="-1"></a>      metadata_one_full</span>
<span id="cb10-337"><a href="data-wrangling.html#cb10-337" aria-hidden="true" tabindex="-1"></a>    joined_data_sets[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-338"><a href="data-wrangling.html#cb10-338" aria-hidden="true" tabindex="-1"></a>      joined_one_full</span>
<span id="cb10-339"><a href="data-wrangling.html#cb10-339" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-340"><a href="data-wrangling.html#cb10-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-341"><a href="data-wrangling.html#cb10-341" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Organize the metadata for export in the R environment</span></span>
<span id="cb10-342"><a href="data-wrangling.html#cb10-342" aria-hidden="true" tabindex="-1"></a>  meta_splits[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-343"><a href="data-wrangling.html#cb10-343" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb10-344"><a href="data-wrangling.html#cb10-344" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Get rid of the non-sweep info</span></span>
<span id="cb10-345"><a href="data-wrangling.html#cb10-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;inception&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-346"><a href="data-wrangling.html#cb10-346" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;initialization&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-347"><a href="data-wrangling.html#cb10-347" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Group by trial</span></span>
<span id="cb10-348"><a href="data-wrangling.html#cb10-348" aria-hidden="true" tabindex="-1"></a>    <span class="co">#group_by(Spatial_Frequency, Temporal_Frequency, Direction) %&gt;%</span></span>
<span id="cb10-349"><a href="data-wrangling.html#cb10-349" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Split by trial group</span></span>
<span id="cb10-350"><a href="data-wrangling.html#cb10-350" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_split</span>(Spatial_Frequency, Temporal_Frequency, Direction)</span>
<span id="cb10-351"><a href="data-wrangling.html#cb10-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-352"><a href="data-wrangling.html#cb10-352" aria-hidden="true" tabindex="-1"></a>  data_splits[[i]] <span class="ot">&lt;-</span></span>
<span id="cb10-353"><a href="data-wrangling.html#cb10-353" aria-hidden="true" tabindex="-1"></a>    joined_data_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb10-354"><a href="data-wrangling.html#cb10-354" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Get rid of the non-sweep info</span></span>
<span id="cb10-355"><a href="data-wrangling.html#cb10-355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;inception&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-356"><a href="data-wrangling.html#cb10-356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>Trial <span class="sc">==</span> <span class="st">&quot;initialization&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-357"><a href="data-wrangling.html#cb10-357" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Group by trial</span></span>
<span id="cb10-358"><a href="data-wrangling.html#cb10-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Spatial_Frequency, Temporal_Frequency, Direction) <span class="sc">%&gt;%</span></span>
<span id="cb10-359"><a href="data-wrangling.html#cb10-359" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Split by trial group</span></span>
<span id="cb10-360"><a href="data-wrangling.html#cb10-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_split</span>()</span>
<span id="cb10-361"><a href="data-wrangling.html#cb10-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-362"><a href="data-wrangling.html#cb10-362" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Do some cleanup so large objects don&#39;t linger in memory</span></span>
<span id="cb10-363"><a href="data-wrangling.html#cb10-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(</span>
<span id="cb10-364"><a href="data-wrangling.html#cb10-364" aria-hidden="true" tabindex="-1"></a>    first_csv, inception, initial, mat_import, first_csv_tmp,</span>
<span id="cb10-365"><a href="data-wrangling.html#cb10-365" aria-hidden="true" tabindex="-1"></a>    photod_default_channel, spikes_default_channel, photod_full,</span>
<span id="cb10-366"><a href="data-wrangling.html#cb10-366" aria-hidden="true" tabindex="-1"></a>    all_spike_dat, all_spike_dat_tmp, all_cells,</span>
<span id="cb10-367"><a href="data-wrangling.html#cb10-367" aria-hidden="true" tabindex="-1"></a>    metadata_one_full, joined_one_full, joined_data_sets,</span>
<span id="cb10-368"><a href="data-wrangling.html#cb10-368" aria-hidden="true" tabindex="-1"></a>    csv_data_sets, mat_data_sets</span>
<span id="cb10-369"><a href="data-wrangling.html#cb10-369" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-370"><a href="data-wrangling.html#cb10-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;File &quot;</span>, i, <span class="st">&quot;: &quot;</span>, csv_mat_filejoin[i,<span class="st">&quot;basename&quot;</span>], <span class="st">&quot; imported&quot;</span>)</span>
<span id="cb10-371"><a href="data-wrangling.html#cb10-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb10-372"><a href="data-wrangling.html#cb10-372" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="data-wrangling.html#cb12-1" aria-hidden="true" tabindex="-1"></a>endtime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb12-2"><a href="data-wrangling.html#cb12-2" aria-hidden="true" tabindex="-1"></a>endtime <span class="sc">-</span> starttime <span class="do">## Total elapsed time</span></span></code></pre></div>
<pre><code>## Time difference of 2.793996 mins</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="data-wrangling.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Tidy up how R has been using RAM by running garbage collection</span></span>
<span id="cb14-2"><a href="data-wrangling.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##             used   (Mb) gc trigger   (Mb) limit (Mb)   max used    (Mb)
## Ncells   5560813  297.0   16155304  862.8         NA   25242661  1348.2
## Vcells 204525780 1560.5  915558166 6985.2      16384 1430559633 10914.4</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="data-wrangling.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Name each data set according to the basename of the file</span></span>
<span id="cb16-2"><a href="data-wrangling.html#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(metadata_sets) <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span>
<span id="cb16-3"><a href="data-wrangling.html#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(meta_splits)   <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span>
<span id="cb16-4"><a href="data-wrangling.html#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(data_splits)   <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span>
<span id="cb16-5"><a href="data-wrangling.html#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="data-wrangling.html#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Get organized lists of stimuli that were used</span></span>
<span id="cb16-7"><a href="data-wrangling.html#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="do">## This will ultimately be used for arranging data by stimuli in a sensible</span></span>
<span id="cb16-8"><a href="data-wrangling.html#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="do">## order</span></span>
<span id="cb16-9"><a href="data-wrangling.html#cb16-9" aria-hidden="true" tabindex="-1"></a>metadata_combos <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb16-10"><a href="data-wrangling.html#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(metadata_sets)) {</span>
<span id="cb16-11"><a href="data-wrangling.html#cb16-11" aria-hidden="true" tabindex="-1"></a>  metadata_combos[[i]] <span class="ot">&lt;-</span></span>
<span id="cb16-12"><a href="data-wrangling.html#cb16-12" aria-hidden="true" tabindex="-1"></a>    metadata_sets[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="data-wrangling.html#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Get unique stimulus parameters</span></span>
<span id="cb16-14"><a href="data-wrangling.html#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(Spatial_Frequency, Temporal_Frequency, Speed, Direction) <span class="sc">%&gt;%</span></span>
<span id="cb16-15"><a href="data-wrangling.html#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Direction) <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="data-wrangling.html#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Sort by SF (smallest to largest)</span></span>
<span id="cb16-17"><a href="data-wrangling.html#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(Spatial_Frequency)) <span class="sc">%&gt;%</span></span>
<span id="cb16-18"><a href="data-wrangling.html#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb16-19"><a href="data-wrangling.html#cb16-19" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Set a &quot;plot_order&quot; which provides a running order of stimuli</span></span>
<span id="cb16-20"><a href="data-wrangling.html#cb16-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot_order =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(meta_splits[[i]]),</span>
<span id="cb16-21"><a href="data-wrangling.html#cb16-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">paste</span>(Direction, <span class="st">&quot;Deg,&quot;</span>,  Speed, <span class="st">&quot;Deg/s&quot;</span>)</span>
<span id="cb16-22"><a href="data-wrangling.html#cb16-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-23"><a href="data-wrangling.html#cb16-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-24"><a href="data-wrangling.html#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(metadata_combos) <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span></code></pre></div>
<p><strong>What we now have is the following:</strong></p>
<ul>
<li><code>metadata_sets</code>: contains a <code>list</code> of <code>tibble</code>s (one per imported
file), each of which comprises the stimulus log</li>
<li><code>metadata_combos</code>: contains a <code>list</code> of <code>tibble</code>s (one per
imported file), each of which comprises the stimulus log
re-written in a preferred plotting order</li>
<li><code>meta_splits</code>: a <code>list</code> of <code>list</code>s. The first level of the <code>list</code>
corresponds to the file identities. Within each file’s <code>list</code>,
there is an additional set of <code>list</code>s, each of which contains a
<code>tibble</code> with the log info for a specific stimulus combination.
Essentially the same as <code>metadata_sets</code> but split up on a
per-stimulus basis.</li>
<li><code>data_splits</code>: another <code>list</code> of <code>list</code>s, arranged in the same
hierarchical order as <code>meta_splits</code>. Each tibble herein contains
the spike and photodiode data from the <code>matlab</code> file on a
per-stimulus basis.</li>
</ul>
<p>Note that since we are only using one example file, each of these
lists should only be 1 element long (with the latter two having
additional elements within the first element)</p>
</div>
</div>
<div id="organizing-replicates-required-and-binning-optional" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Organizing replicates (required) and binning (optional)<a href="data-wrangling.html#organizing-replicates-required-and-binning-optional" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>It is common to record several different sweeps of a stimulus to
collect (somewhat) independent replicates of neural responses. The
primary task of this section will be to use the lists from the
previous section to gather &amp; label replicates of the same stimulus.</p>
<p>A secondary task is to deal with binning, if desired (highly
recommended). Depending on the goals of plotting and/or analyses, it
may be wise to work with either unbinned spike data or to bin the data
at a convenient and sensible interval. I generally choose to work at
the following levels:</p>
<ol style="list-style-type: decimal">
<li>Unbinned</li>
<li>Bin size = 10 ms</li>
<li>Bin size = 100 ms</li>
</ol>
<p><strong>Important note:</strong> Rather than provide separate code for each of
these 3 scenarios, I will provide one example. Bin size <strong>must</strong> be
declared beforehand – please pay attention.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="data-wrangling.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set bin size here</span></span>
<span id="cb17-2"><a href="data-wrangling.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Units are in ms (e.g. 10 = 10ms)</span></span>
<span id="cb17-3"><a href="data-wrangling.html#cb17-3" aria-hidden="true" tabindex="-1"></a>bin_size <span class="ot">=</span> <span class="dv">10</span> <span class="do">## 10 or 100 or 1 (1 = &quot;unbinned&quot;)</span></span>
<span id="cb17-4"><a href="data-wrangling.html#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="data-wrangling.html#cb17-5" aria-hidden="true" tabindex="-1"></a>slice_size <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb17-6"><a href="data-wrangling.html#cb17-6" aria-hidden="true" tabindex="-1"></a>slicemin <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb17-7"><a href="data-wrangling.html#cb17-7" aria-hidden="true" tabindex="-1"></a>slicemax <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb17-8"><a href="data-wrangling.html#cb17-8" aria-hidden="true" tabindex="-1"></a>condition <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb17-9"><a href="data-wrangling.html#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (bin_size <span class="sc">==</span> <span class="dv">10</span>){</span>
<span id="cb17-10"><a href="data-wrangling.html#cb17-10" aria-hidden="true" tabindex="-1"></a>  slice_size <span class="ot">&lt;-</span> <span class="dv">501</span></span>
<span id="cb17-11"><a href="data-wrangling.html#cb17-11" aria-hidden="true" tabindex="-1"></a>  slicemin <span class="ot">&lt;-</span> <span class="dv">202</span></span>
<span id="cb17-12"><a href="data-wrangling.html#cb17-12" aria-hidden="true" tabindex="-1"></a>  slicemax <span class="ot">&lt;-</span> <span class="dv">498</span></span>
<span id="cb17-13"><a href="data-wrangling.html#cb17-13" aria-hidden="true" tabindex="-1"></a>  condition <span class="ot">&lt;-</span> <span class="st">&quot;_binsize10&quot;</span></span>
<span id="cb17-14"><a href="data-wrangling.html#cb17-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (bin_size <span class="sc">==</span> <span class="dv">100</span>){</span>
<span id="cb17-15"><a href="data-wrangling.html#cb17-15" aria-hidden="true" tabindex="-1"></a>  slice_size <span class="ot">&lt;-</span> <span class="dv">51</span></span>
<span id="cb17-16"><a href="data-wrangling.html#cb17-16" aria-hidden="true" tabindex="-1"></a>  slicemin <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb17-17"><a href="data-wrangling.html#cb17-17" aria-hidden="true" tabindex="-1"></a>  slicemax <span class="ot">&lt;-</span> <span class="dv">49</span></span>
<span id="cb17-18"><a href="data-wrangling.html#cb17-18" aria-hidden="true" tabindex="-1"></a>  condition <span class="ot">&lt;-</span> <span class="st">&quot;_binsize100&quot;</span></span>
<span id="cb17-19"><a href="data-wrangling.html#cb17-19" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (bin_size <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb17-20"><a href="data-wrangling.html#cb17-20" aria-hidden="true" tabindex="-1"></a>  slice_size <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb17-21"><a href="data-wrangling.html#cb17-21" aria-hidden="true" tabindex="-1"></a>  slicemin <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb17-22"><a href="data-wrangling.html#cb17-22" aria-hidden="true" tabindex="-1"></a>  slicemax <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb17-23"><a href="data-wrangling.html#cb17-23" aria-hidden="true" tabindex="-1"></a>  condition <span class="ot">&lt;-</span> <span class="st">&quot;_unbinned&quot;</span></span>
<span id="cb17-24"><a href="data-wrangling.html#cb17-24" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb17-25"><a href="data-wrangling.html#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&quot;bin_size is non-standard&quot;</span>)</span>
<span id="cb17-26"><a href="data-wrangling.html#cb17-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-27"><a href="data-wrangling.html#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="data-wrangling.html#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="data-wrangling.html#cb17-29" aria-hidden="true" tabindex="-1"></a>all_replicate_data_reorganized <span class="ot">&lt;-</span></span>
<span id="cb17-30"><a href="data-wrangling.html#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="at">length =</span> <span class="fu">length</span>(meta_splits))</span>
<span id="cb17-31"><a href="data-wrangling.html#cb17-31" aria-hidden="true" tabindex="-1"></a>name_sets <span class="ot">&lt;-</span></span>
<span id="cb17-32"><a href="data-wrangling.html#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;list&quot;</span>, <span class="at">length =</span> <span class="fu">length</span>(meta_splits))</span>
<span id="cb17-33"><a href="data-wrangling.html#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##             used   (Mb) gc trigger   (Mb) limit (Mb)   max used    (Mb)
## Ncells   5560919  297.0   16155304  862.8         NA   25242661  1348.2
## Vcells 204518199 1560.4  732446533 5588.2      16384 1430559633 10914.4</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="data-wrangling.html#cb19-1" aria-hidden="true" tabindex="-1"></a>starttime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb19-2"><a href="data-wrangling.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(meta_splits)){</span>
<span id="cb19-3"><a href="data-wrangling.html#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="data-wrangling.html#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## i = file number</span></span>
<span id="cb19-5"><a href="data-wrangling.html#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb19-6"><a href="data-wrangling.html#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="data-wrangling.html#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## We&#39;ll need to collect data at a per-stimulus level and on a per-replicate</span></span>
<span id="cb19-8"><a href="data-wrangling.html#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## level within the per-stimulus level</span></span>
<span id="cb19-9"><a href="data-wrangling.html#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## &quot;j&quot; will be used to designate a unique stimulus</span></span>
<span id="cb19-10"><a href="data-wrangling.html#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## We&#39;ll first create an empty object in which to collect stimulus-specific</span></span>
<span id="cb19-11"><a href="data-wrangling.html#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## data</span></span>
<span id="cb19-12"><a href="data-wrangling.html#cb19-12" aria-hidden="true" tabindex="-1"></a>  replicate_data_reorganized <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-13"><a href="data-wrangling.html#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For each of j unique stimuli...</span></span>
<span id="cb19-14"><a href="data-wrangling.html#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(meta_splits[[i]])) { <span class="co"># j = {direction,speed}</span></span>
<span id="cb19-15"><a href="data-wrangling.html#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Isolate the j-th data</span></span>
<span id="cb19-16"><a href="data-wrangling.html#cb19-16" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> data_splits[[i]][[j]]</span>
<span id="cb19-17"><a href="data-wrangling.html#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="do">## And the j-th log data</span></span>
<span id="cb19-18"><a href="data-wrangling.html#cb19-18" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> meta_splits[[i]][[j]] <span class="sc">%&gt;%</span></span>
<span id="cb19-19"><a href="data-wrangling.html#cb19-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Trial) <span class="sc">%&gt;%</span></span>
<span id="cb19-20"><a href="data-wrangling.html#cb19-20" aria-hidden="true" tabindex="-1"></a>      <span class="do">## Label separate replicates</span></span>
<span id="cb19-21"><a href="data-wrangling.html#cb19-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Replicate =</span> <span class="fu">row_number</span>())</span>
<span id="cb19-22"><a href="data-wrangling.html#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="data-wrangling.html#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract a stimulus label to a name_set that will be used later</span></span>
<span id="cb19-24"><a href="data-wrangling.html#cb19-24" aria-hidden="true" tabindex="-1"></a>    name_sets[[i]][[j]] <span class="ot">&lt;-</span></span>
<span id="cb19-25"><a href="data-wrangling.html#cb19-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(m<span class="sc">$</span>Direction[<span class="dv">1</span>], <span class="st">&quot;Deg,&quot;</span>,  m<span class="sc">$</span>Speed[<span class="dv">1</span>], <span class="st">&quot;Deg/s&quot;</span>)</span>
<span id="cb19-26"><a href="data-wrangling.html#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="data-wrangling.html#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Set up a temporary object to deal with per-replicate data</span></span>
<span id="cb19-28"><a href="data-wrangling.html#cb19-28" aria-hidden="true" tabindex="-1"></a>    replicates_ordered <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-29"><a href="data-wrangling.html#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="do">## &quot;k&quot; will be used to designate replicate number</span></span>
<span id="cb19-30"><a href="data-wrangling.html#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(m<span class="sc">$</span>Replicate)){</span>
<span id="cb19-31"><a href="data-wrangling.html#cb19-31" aria-hidden="true" tabindex="-1"></a>      tmp <span class="ot">&lt;-</span></span>
<span id="cb19-32"><a href="data-wrangling.html#cb19-32" aria-hidden="true" tabindex="-1"></a>        m <span class="sc">%&gt;%</span></span>
<span id="cb19-33"><a href="data-wrangling.html#cb19-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Replicate <span class="sc">==</span> k)</span>
<span id="cb19-34"><a href="data-wrangling.html#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="data-wrangling.html#cb19-35" aria-hidden="true" tabindex="-1"></a>      <span class="do">## If you have a complete replicate (i.e., blank, stationary, moving)</span></span>
<span id="cb19-36"><a href="data-wrangling.html#cb19-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(tmp) <span class="sc">==</span> <span class="dv">3</span> ) {</span>
<span id="cb19-37"><a href="data-wrangling.html#cb19-37" aria-hidden="true" tabindex="-1"></a>        <span class="do">## Grab the specific data</span></span>
<span id="cb19-38"><a href="data-wrangling.html#cb19-38" aria-hidden="true" tabindex="-1"></a>        doot <span class="ot">&lt;-</span></span>
<span id="cb19-39"><a href="data-wrangling.html#cb19-39" aria-hidden="true" tabindex="-1"></a>          d <span class="sc">%&gt;%</span></span>
<span id="cb19-40"><a href="data-wrangling.html#cb19-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(Time <span class="sc">&gt;=</span> <span class="fu">min</span>(tmp<span class="sc">$</span>Time)) <span class="sc">%&gt;%</span></span>
<span id="cb19-41"><a href="data-wrangling.html#cb19-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> <span class="fu">max</span>(tmp<span class="sc">$</span>Stim_end))</span>
<span id="cb19-42"><a href="data-wrangling.html#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="do">## Add bin information</span></span>
<span id="cb19-43"><a href="data-wrangling.html#cb19-43" aria-hidden="true" tabindex="-1"></a>        doot<span class="sc">$</span>bin <span class="ot">&lt;-</span></span>
<span id="cb19-44"><a href="data-wrangling.html#cb19-44" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ceiling</span>(<span class="fu">nrow</span>(doot)<span class="sc">/</span>bin_size), <span class="at">each =</span> bin_size)[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(doot)]</span>
<span id="cb19-45"><a href="data-wrangling.html#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="data-wrangling.html#cb19-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (bin_size <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb19-47"><a href="data-wrangling.html#cb19-47" aria-hidden="true" tabindex="-1"></a>          <span class="do">## IF YOU ARE NOT BINNING, RUN THIS:</span></span>
<span id="cb19-48"><a href="data-wrangling.html#cb19-48" aria-hidden="true" tabindex="-1"></a>          replicates_ordered[[k]] <span class="ot">&lt;-</span></span>
<span id="cb19-49"><a href="data-wrangling.html#cb19-49" aria-hidden="true" tabindex="-1"></a>            doot <span class="sc">%&gt;%</span></span>
<span id="cb19-50"><a href="data-wrangling.html#cb19-50" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb19-51"><a href="data-wrangling.html#cb19-51" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Construct a standardized time within the sweep</span></span>
<span id="cb19-52"><a href="data-wrangling.html#cb19-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_stand =</span> Time_mat <span class="sc">-</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb19-53"><a href="data-wrangling.html#cb19-53" aria-hidden="true" tabindex="-1"></a>              <span class="do">## When does the sweep begin</span></span>
<span id="cb19-54"><a href="data-wrangling.html#cb19-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_begin =</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb19-55"><a href="data-wrangling.html#cb19-55" aria-hidden="true" tabindex="-1"></a>              <span class="do">## When does the sweep end</span></span>
<span id="cb19-56"><a href="data-wrangling.html#cb19-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_end =</span> <span class="fu">max</span>(Time_mat),</span>
<span id="cb19-57"><a href="data-wrangling.html#cb19-57" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Delineate the end of the blank phase</span></span>
<span id="cb19-58"><a href="data-wrangling.html#cb19-58" aria-hidden="true" tabindex="-1"></a>              <span class="at">Blank_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb19-59"><a href="data-wrangling.html#cb19-59" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Delineate the end of the stationary phase</span></span>
<span id="cb19-60"><a href="data-wrangling.html#cb19-60" aria-hidden="true" tabindex="-1"></a>              <span class="at">Static_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb19-61"><a href="data-wrangling.html#cb19-61" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Label the replicate number</span></span>
<span id="cb19-62"><a href="data-wrangling.html#cb19-62" aria-hidden="true" tabindex="-1"></a>              <span class="at">Replicate =</span> k</span>
<span id="cb19-63"><a href="data-wrangling.html#cb19-63" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb19-64"><a href="data-wrangling.html#cb19-64" aria-hidden="true" tabindex="-1"></a>            <span class="do">## Bring stim info to first few columns</span></span>
<span id="cb19-65"><a href="data-wrangling.html#cb19-65" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(Speed, Spatial_Frequency, Temporal_Frequency, Direction,</span>
<span id="cb19-66"><a href="data-wrangling.html#cb19-66" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb19-67"><a href="data-wrangling.html#cb19-67" aria-hidden="true" tabindex="-1"></a>            <span class="do">## Just in case there some hang over</span></span>
<span id="cb19-68"><a href="data-wrangling.html#cb19-68" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(Time_stand <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb19-69"><a href="data-wrangling.html#cb19-69" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> { <span class="do">## IF YOU ARE BINNING, RUN THIS:</span></span>
<span id="cb19-70"><a href="data-wrangling.html#cb19-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-71"><a href="data-wrangling.html#cb19-71" aria-hidden="true" tabindex="-1"></a>          <span class="do">## First grab time and meta info</span></span>
<span id="cb19-72"><a href="data-wrangling.html#cb19-72" aria-hidden="true" tabindex="-1"></a>          time_and_meta <span class="ot">&lt;-</span></span>
<span id="cb19-73"><a href="data-wrangling.html#cb19-73" aria-hidden="true" tabindex="-1"></a>            doot <span class="sc">%&gt;%</span></span>
<span id="cb19-74"><a href="data-wrangling.html#cb19-74" aria-hidden="true" tabindex="-1"></a>            <span class="do">## WITHIN EACH BIN:</span></span>
<span id="cb19-75"><a href="data-wrangling.html#cb19-75" aria-hidden="true" tabindex="-1"></a>            <span class="fu">group_by</span>(bin) <span class="sc">%&gt;%</span></span>
<span id="cb19-76"><a href="data-wrangling.html#cb19-76" aria-hidden="true" tabindex="-1"></a>            <span class="fu">summarise</span>(</span>
<span id="cb19-77"><a href="data-wrangling.html#cb19-77" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Label the trial</span></span>
<span id="cb19-78"><a href="data-wrangling.html#cb19-78" aria-hidden="true" tabindex="-1"></a>              <span class="at">Trial =</span> <span class="fu">first</span>(Trial),</span>
<span id="cb19-79"><a href="data-wrangling.html#cb19-79" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Midpoint of bin</span></span>
<span id="cb19-80"><a href="data-wrangling.html#cb19-80" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_bin_mid =</span> <span class="fu">mean</span>(Time_mat),</span>
<span id="cb19-81"><a href="data-wrangling.html#cb19-81" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Bin beginning</span></span>
<span id="cb19-82"><a href="data-wrangling.html#cb19-82" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_bin_begin =</span> <span class="fu">min</span>(Time_mat),</span>
<span id="cb19-83"><a href="data-wrangling.html#cb19-83" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Bin end</span></span>
<span id="cb19-84"><a href="data-wrangling.html#cb19-84" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_bin_end =</span> <span class="fu">max</span>(Time_mat),</span>
<span id="cb19-85"><a href="data-wrangling.html#cb19-85" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Spike rate = sum of spikes divided by elapsed time</span></span>
<span id="cb19-86"><a href="data-wrangling.html#cb19-86" aria-hidden="true" tabindex="-1"></a>              <span class="at">Spike_rate =</span> <span class="fu">sum</span>(Spikes) <span class="sc">/</span> (<span class="fu">max</span>(Time_mat) <span class="sc">-</span> <span class="fu">min</span>(Time_mat)),</span>
<span id="cb19-87"><a href="data-wrangling.html#cb19-87" aria-hidden="true" tabindex="-1"></a>              <span class="at">Photod_mean =</span> <span class="fu">mean</span>(Photod)</span>
<span id="cb19-88"><a href="data-wrangling.html#cb19-88" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-89"><a href="data-wrangling.html#cb19-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-90"><a href="data-wrangling.html#cb19-90" aria-hidden="true" tabindex="-1"></a>          <span class="do">## Now deal with Spike_N columns</span></span>
<span id="cb19-91"><a href="data-wrangling.html#cb19-91" aria-hidden="true" tabindex="-1"></a>          hold_spike_n <span class="ot">&lt;-</span></span>
<span id="cb19-92"><a href="data-wrangling.html#cb19-92" aria-hidden="true" tabindex="-1"></a>            doot <span class="sc">%&gt;%</span></span>
<span id="cb19-93"><a href="data-wrangling.html#cb19-93" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;Spikes_&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-94"><a href="data-wrangling.html#cb19-94" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_column</span>(<span class="at">bin =</span> doot<span class="sc">$</span>bin) <span class="sc">%&gt;%</span></span>
<span id="cb19-95"><a href="data-wrangling.html#cb19-95" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_column</span>(<span class="at">Time_mat =</span> doot<span class="sc">$</span>Time_mat) <span class="sc">%&gt;%</span></span>
<span id="cb19-96"><a href="data-wrangling.html#cb19-96" aria-hidden="true" tabindex="-1"></a>            <span class="fu">group_by</span>(bin) <span class="sc">%&gt;%</span></span>
<span id="cb19-97"><a href="data-wrangling.html#cb19-97" aria-hidden="true" tabindex="-1"></a>            <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;Spikes_&quot;</span>),</span>
<span id="cb19-98"><a href="data-wrangling.html#cb19-98" aria-hidden="true" tabindex="-1"></a>                             <span class="sc">~</span> <span class="fu">sum</span>(.x) <span class="sc">/</span> (<span class="fu">max</span>(Time_mat) <span class="sc">-</span> <span class="fu">min</span>(Time_mat))))</span>
<span id="cb19-99"><a href="data-wrangling.html#cb19-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-100"><a href="data-wrangling.html#cb19-100" aria-hidden="true" tabindex="-1"></a>          <span class="do">## Put them together</span></span>
<span id="cb19-101"><a href="data-wrangling.html#cb19-101" aria-hidden="true" tabindex="-1"></a>          replicates_ordered[[k]] <span class="ot">&lt;-</span></span>
<span id="cb19-102"><a href="data-wrangling.html#cb19-102" aria-hidden="true" tabindex="-1"></a>            time_and_meta <span class="sc">%&gt;%</span></span>
<span id="cb19-103"><a href="data-wrangling.html#cb19-103" aria-hidden="true" tabindex="-1"></a>            <span class="fu">left_join</span>(hold_spike_n, <span class="at">by =</span> <span class="st">&quot;bin&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-104"><a href="data-wrangling.html#cb19-104" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb19-105"><a href="data-wrangling.html#cb19-105" aria-hidden="true" tabindex="-1"></a>              <span class="do">## Add in metadata (following same definitions above)</span></span>
<span id="cb19-106"><a href="data-wrangling.html#cb19-106" aria-hidden="true" tabindex="-1"></a>              <span class="at">Time_stand =</span> Time_bin_mid <span class="sc">-</span> <span class="fu">min</span>(Time_bin_mid),</span>
<span id="cb19-107"><a href="data-wrangling.html#cb19-107" aria-hidden="true" tabindex="-1"></a>              <span class="at">Blank_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_bin_mid),</span>
<span id="cb19-108"><a href="data-wrangling.html#cb19-108" aria-hidden="true" tabindex="-1"></a>              <span class="at">Static_end =</span> tmp<span class="sc">$</span>Stim_end[<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">min</span>(Time_bin_mid),</span>
<span id="cb19-109"><a href="data-wrangling.html#cb19-109" aria-hidden="true" tabindex="-1"></a>              <span class="at">Spatial_Frequency =</span> m<span class="sc">$</span>Spatial_Frequency[<span class="dv">1</span>],</span>
<span id="cb19-110"><a href="data-wrangling.html#cb19-110" aria-hidden="true" tabindex="-1"></a>              <span class="at">Temporal_Frequency =</span> m<span class="sc">$</span>Temporal_Frequency[<span class="dv">1</span>],</span>
<span id="cb19-111"><a href="data-wrangling.html#cb19-111" aria-hidden="true" tabindex="-1"></a>              <span class="at">Speed =</span> m<span class="sc">$</span>Speed[<span class="dv">1</span>],</span>
<span id="cb19-112"><a href="data-wrangling.html#cb19-112" aria-hidden="true" tabindex="-1"></a>              <span class="at">Direction =</span> m<span class="sc">$</span>Direction[<span class="dv">1</span>],</span>
<span id="cb19-113"><a href="data-wrangling.html#cb19-113" aria-hidden="true" tabindex="-1"></a>              <span class="at">Replicate =</span> k</span>
<span id="cb19-114"><a href="data-wrangling.html#cb19-114" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb19-115"><a href="data-wrangling.html#cb19-115" aria-hidden="true" tabindex="-1"></a>            <span class="do">## Bring stim info to first few columns</span></span>
<span id="cb19-116"><a href="data-wrangling.html#cb19-116" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(Speed, Spatial_Frequency, Temporal_Frequency, Direction,</span>
<span id="cb19-117"><a href="data-wrangling.html#cb19-117" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb19-118"><a href="data-wrangling.html#cb19-118" aria-hidden="true" tabindex="-1"></a>            <span class="do">## Just in case there some hang over</span></span>
<span id="cb19-119"><a href="data-wrangling.html#cb19-119" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(Time_stand <span class="sc">&gt;=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-120"><a href="data-wrangling.html#cb19-120" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(bin <span class="sc">&lt;</span> slice_size <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb19-121"><a href="data-wrangling.html#cb19-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-122"><a href="data-wrangling.html#cb19-122" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rm</span>(time_and_meta, hold_spike_n)</span>
<span id="cb19-123"><a href="data-wrangling.html#cb19-123" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-124"><a href="data-wrangling.html#cb19-124" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb19-125"><a href="data-wrangling.html#cb19-125" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb19-126"><a href="data-wrangling.html#cb19-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-127"><a href="data-wrangling.html#cb19-127" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Now insert it within the collector of per-stimulus data</span></span>
<span id="cb19-128"><a href="data-wrangling.html#cb19-128" aria-hidden="true" tabindex="-1"></a>    replicate_data_reorganized[[j]] <span class="ot">&lt;-</span></span>
<span id="cb19-129"><a href="data-wrangling.html#cb19-129" aria-hidden="true" tabindex="-1"></a>      replicates_ordered <span class="sc">%&gt;%</span></span>
<span id="cb19-130"><a href="data-wrangling.html#cb19-130" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>()</span>
<span id="cb19-131"><a href="data-wrangling.html#cb19-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-132"><a href="data-wrangling.html#cb19-132" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Now insert it within the overall data collector</span></span>
<span id="cb19-133"><a href="data-wrangling.html#cb19-133" aria-hidden="true" tabindex="-1"></a>    all_replicate_data_reorganized[[i]][[j]] <span class="ot">&lt;-</span></span>
<span id="cb19-134"><a href="data-wrangling.html#cb19-134" aria-hidden="true" tabindex="-1"></a>      replicate_data_reorganized[[j]]</span>
<span id="cb19-135"><a href="data-wrangling.html#cb19-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-136"><a href="data-wrangling.html#cb19-136" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Toss out temporary objects and clean up</span></span>
<span id="cb19-137"><a href="data-wrangling.html#cb19-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(replicates_ordered, d, m, tmp)</span>
<span id="cb19-138"><a href="data-wrangling.html#cb19-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb19-139"><a href="data-wrangling.html#cb19-139" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-140"><a href="data-wrangling.html#cb19-140" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="data-wrangling.html#cb21-1" aria-hidden="true" tabindex="-1"></a>endtime <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb21-2"><a href="data-wrangling.html#cb21-2" aria-hidden="true" tabindex="-1"></a>endtime <span class="sc">-</span> starttime</span></code></pre></div>
<pre><code>## Time difference of 2.348608 mins</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="data-wrangling.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code></pre></div>
<pre><code>##             used   (Mb) gc trigger   (Mb) limit (Mb)   max used    (Mb)
## Ncells   5565855  297.3   16155304  862.8         NA   25242661  1348.2
## Vcells 208867772 1593.6  585957227 4470.5      16384 1430559633 10914.4</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="data-wrangling.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_replicate_data_reorganized)) {</span>
<span id="cb25-2"><a href="data-wrangling.html#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_replicate_data_reorganized[[i]])) {</span>
<span id="cb25-3"><a href="data-wrangling.html#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(all_replicate_data_reorganized[[i]])[[j]] <span class="ot">&lt;-</span> name_sets[[i]][[j]]</span>
<span id="cb25-4"><a href="data-wrangling.html#cb25-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-5"><a href="data-wrangling.html#cb25-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-6"><a href="data-wrangling.html#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(all_replicate_data_reorganized) <span class="ot">&lt;-</span> csv_mat_filejoin<span class="sc">$</span>basename <span class="co">#base_names</span></span></code></pre></div>
<p>At the end of this process, here is how <code>all_replicate_data_reorganized[[1]]</code>
should look:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="data-wrangling.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## How long is this list?</span></span>
<span id="cb26-2"><a href="data-wrangling.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(all_replicate_data_reorganized[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## [1] 80</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="data-wrangling.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">## This object contains 48 individual tibbles. Here&#39;s an example of one</span></span>
<span id="cb28-2"><a href="data-wrangling.html#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="do">## pulled at random</span></span>
<span id="cb28-3"><a href="data-wrangling.html#cb28-3" aria-hidden="true" tabindex="-1"></a>all_replicate_data_reorganized[[<span class="dv">1</span>]][<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">48</span>, <span class="at">size =</span> <span class="dv">1</span>)]</span></code></pre></div>
<pre><code>## $`90 Deg, 1024 Deg/s`
## # A tibble: 4,008 × 16
##    Speed Spatial_F…¹ Tempo…² Direc…³   bin Trial Time_…⁴ Time_…⁵ Time_…⁶ Spike…⁷
##    &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1  1024      0.0156      16      90     1 blank    33.3    33.3    33.3      0 
##  2  1024      0.0156      16      90     2 blank    33.3    33.3    33.3      0 
##  3  1024      0.0156      16      90     3 blank    33.3    33.3    33.4      0 
##  4  1024      0.0156      16      90     4 blank    33.4    33.4    33.4      0 
##  5  1024      0.0156      16      90     5 blank    33.4    33.4    33.4      0 
##  6  1024      0.0156      16      90     6 blank    33.4    33.4    33.4      0 
##  7  1024      0.0156      16      90     7 blank    33.4    33.4    33.4      0 
##  8  1024      0.0156      16      90     8 blank    33.4    33.4    33.4    222.
##  9  1024      0.0156      16      90     9 blank    33.4    33.4    33.4    111.
## 10  1024      0.0156      16      90    10 blank    33.4    33.4    33.4      0 
## # … with 3,998 more rows, 6 more variables: Photod_mean &lt;dbl&gt;, Spikes_0 &lt;dbl&gt;,
## #   Time_stand &lt;dbl&gt;, Blank_end &lt;dbl&gt;, Static_end &lt;dbl&gt;, Replicate &lt;int&gt;, and
## #   abbreviated variable names ¹​Spatial_Frequency, ²​Temporal_Frequency,
## #   ³​Direction, ⁴​Time_bin_mid, ⁵​Time_bin_begin, ⁶​Time_bin_end, ⁷​Spike_rate</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="data-wrangling.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## To consolidate this, you can use bind_rows()</span></span>
<span id="cb30-2"><a href="data-wrangling.html#cb30-2" aria-hidden="true" tabindex="-1"></a>all_replicate_data_reorganized[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> bind_rows</span></code></pre></div>
<pre><code>## # A tibble: 284,067 × 16
##    Speed Spatial_F…¹ Tempo…² Direc…³   bin Trial Time_…⁴ Time_…⁵ Time_…⁶ Spike…⁷
##    &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1  1024      0.0156      16       0     1 blank    181.    181.    181.      0 
##  2  1024      0.0156      16       0     2 blank    181.    181.    181.      0 
##  3  1024      0.0156      16       0     3 blank    181.    181.    181.      0 
##  4  1024      0.0156      16       0     4 blank    181.    181.    181.      0 
##  5  1024      0.0156      16       0     5 blank    181.    181.    181.      0 
##  6  1024      0.0156      16       0     6 blank    181.    181.    181.      0 
##  7  1024      0.0156      16       0     7 blank    181.    181.    181.      0 
##  8  1024      0.0156      16       0     8 blank    181.    181.    181.    222.
##  9  1024      0.0156      16       0     9 blank    181.    181.    181.    222.
## 10  1024      0.0156      16       0    10 blank    181.    181.    181.    111.
## # … with 284,057 more rows, 6 more variables: Photod_mean &lt;dbl&gt;,
## #   Spikes_0 &lt;dbl&gt;, Time_stand &lt;dbl&gt;, Blank_end &lt;dbl&gt;, Static_end &lt;dbl&gt;,
## #   Replicate &lt;int&gt;, and abbreviated variable names ¹​Spatial_Frequency,
## #   ²​Temporal_Frequency, ³​Direction, ⁴​Time_bin_mid, ⁵​Time_bin_begin,
## #   ⁶​Time_bin_end, ⁷​Spike_rate</code></pre>
<p><strong>Bear in mind that I am specifically describing
<code>all_replicate_data_reorganized[[1]]</code>, NOT <code>all_replicate_data_reorganized</code>.</strong>
This is because <code>all_replicate_data_reorganized</code> will itself be a <code>list</code> that is
as long as the number of distinct data files you are feeding into all of the
above. Since there is only 1 example file, <code>all_replicate_data_reorganized</code> is a
<code>list</code> that is only 1 entry long at its top level, and within that <code>list</code> is set
of 48 <code>list</code>s (one per distinct stimulus), each of which contains a
stim-specific <code>tibble</code> of data.</p>
</div>
<div id="data-export" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Data export<a href="data-wrangling.html#data-export" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>It is highly recommended that you export
<code>all_replicate_data_reorganized</code>. I generally export
<code>all_replicate_data_reorganized</code> as a separate <code>csv</code> file for each of
the following conditions:</p>
<ol style="list-style-type: decimal">
<li>Unbinned</li>
<li>Bin size = 10 ms</li>
<li>Bin size = 100 ms</li>
</ol>
<p>This section will provide code to export each of the above, assuming
you used those bin sizes in the previous section. Please be sure to
change file naming conventions and other parameters in the event you
chose a different <code>bin_size</code> in the previous section.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="data-wrangling.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Declare export destination</span></span>
<span id="cb32-2"><a href="data-wrangling.html#cb32-2" aria-hidden="true" tabindex="-1"></a>export_path <span class="ot">&lt;-</span> <span class="st">&quot;./data/&quot;</span></span>
<span id="cb32-3"><a href="data-wrangling.html#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="do">## The &quot;condition&quot; will be appended to the file name.</span></span>
<span id="cb32-4"><a href="data-wrangling.html#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="data-wrangling.html#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Export each tibble within all_replicate_data_reorganized</span></span>
<span id="cb32-6"><a href="data-wrangling.html#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(all_replicate_data_reorganized)) {</span>
<span id="cb32-7"><a href="data-wrangling.html#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb32-8"><a href="data-wrangling.html#cb32-8" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span></span>
<span id="cb32-9"><a href="data-wrangling.html#cb32-9" aria-hidden="true" tabindex="-1"></a>    all_replicate_data_reorganized[[i]] <span class="sc">%&gt;%</span></span>
<span id="cb32-10"><a href="data-wrangling.html#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb32-11"><a href="data-wrangling.html#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(</span>
<span id="cb32-12"><a href="data-wrangling.html#cb32-12" aria-hidden="true" tabindex="-1"></a>    dat,</span>
<span id="cb32-13"><a href="data-wrangling.html#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span></span>
<span id="cb32-14"><a href="data-wrangling.html#cb32-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(</span>
<span id="cb32-15"><a href="data-wrangling.html#cb32-15" aria-hidden="true" tabindex="-1"></a>        export_path,</span>
<span id="cb32-16"><a href="data-wrangling.html#cb32-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(all_replicate_data_reorganized)[i],</span>
<span id="cb32-17"><a href="data-wrangling.html#cb32-17" aria-hidden="true" tabindex="-1"></a>        condition,</span>
<span id="cb32-18"><a href="data-wrangling.html#cb32-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;.csv&quot;</span></span>
<span id="cb32-19"><a href="data-wrangling.html#cb32-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb32-20"><a href="data-wrangling.html#cb32-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-21"><a href="data-wrangling.html#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(dat)</span>
<span id="cb32-22"><a href="data-wrangling.html#cb32-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Re-run the above chunk of code per condition you seek to export. For me, this
process creates 3 files: <code>2023-02-16_001_unbinned.csv</code>,
<code>2023-02-16_001_binsize10.csv</code>, and <code>2023-02-16_001_binsize100.csv</code>.</p>
<p>🐢</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="raw-data-and-spike-sorted-traces.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="raster-and-mean-spike-rate-plots.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"highlight": "tango",
"info": true
});
});
</script>

</body>

</html>
